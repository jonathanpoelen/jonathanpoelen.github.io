<!DOCTYPE html>
<html lang="fr-FR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jonathan Poelen&#39;s Blog</title>
<meta name="generator" content="Hugo 0.53" />

<link rel="alternate" type="application/rss+xml" title="Jonathan Poelen&#39;s Blog Feed" href="https://jonathanpoelen.github.io/index.xml" />

<link rel="stylesheet" type="text/css" media="all" href="https://fonts.googleapis.com/css?family=Droid+Serif" crossorigin="anonymous" />
<link rel="stylesheet" type="text/css" media="all" href="https://fonts.googleapis.com/css?family=Noto+Sans" crossorigin="anonymous" />

<link rel="stylesheet" type="text/css" media="all" href="https://jonathanpoelen.github.io/css/style.min.45ee239dece7b254e05290f1efc66e1c5639e4de2556397e3915d9f4af662696.css">
<link rel="stylesheet" type="text/css" media="all" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous" />
<link rel="shortcut icon" href="/favicon.jpg"/>
<link rel="icon" sizes="32x32" href="/favicon-32.jpg" type="image/jpeg">
<link rel="icon" sizes="64x64" href="/favicon-64.jpg" type="image/jpeg">
<link rel="icon" sizes="96x96" href="/favicon-96.jpg" type="image/jpeg"> 
<link rel="icon" sizes="128x128" href="/favicon-128.jpg" type="image/jpeg">
<meta property="og:site_name" content="Jonathan Poelen&#39;s Blog">
<meta property="og:title" content="Jonathan Poelen&#39;s Blog">
<meta property="og:url" content="https://jonathanpoelen.github.io/">
<meta property="og:language" content="fr-FR">
<meta property="twitter:domain" content="https://jonathanpoelen.github.io/">
<meta property="twitter:card" content="summary">
<meta property="twitter:url" content="https://jonathanpoelen.github.io/">
<meta property="twitter:title" content="Jonathan Poelen&#39;s Blog">
<meta name="description" content="Le blog de Jonathan Poelen.Mon petit mémo sur tout ce qui touche à la programmation =)">
<meta property="twitter:description" content="Le blog de Jonathan Poelen.Mon petit mémo sur tout ce qui touche à la programmation =)">

</head>
<body class="body body-right-sidebar mobile" itemscope="itemscope" itemtype="http://schema.org/WebPage">
  <div id="avoidance-link">
    <a class="evitement" href="#main-content" title="Aller au contenu">Aller au contenu</a>
    <a class="evitement" href="#main-menu" title="Aller au menu">Aller au menu</a>
  </div>
  <div class="container container-outer">
    <header class="header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
      <div class="container-inner">
        <div class="logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
          <a class="logo__link" href="/" title="Jonathan Poelen&#39;s Blog" rel="home">
            <h1 class="logo__title">Le blog de Jonathan Poelen</h1>
            <h2 class="logo__tagline">Mon petit mémo sur tout ce qui touche à la programmation =)</h2>
          </a>
        </div>
        <nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
  <ul class="menu__list">
    <li class="menu__item"><a class="menu__link" title="GitHub" rel="noopener noreferrer" href="https://github.com/jonathanpoelen">
      <i class="fab fa-github" aria-hidden="true"></i> Github
    </a></li>
    <li class="menu__item "><a class="menu__link" title="Archives" href="/archives">
      <i class="fas fa-archive" aria-hidden="true"></i> Archives</a>
    </li>
    <li class="menu__item"><a class="menu__link" title="Flux RSS" href="/index.xml">
      <i class="fas fa-rss" aria-hidden="true"></i> RSS</a>
    </li>
  </ul>
</nav>


      </div>
    </header>
    <div class="wrapper clearfix">


<aside class="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
	
<div class="widget-search widget">
  <form class="widget-search__form" role="search" method="get" action="https://duckduckgo.com">
    <label>
      <span class="screen-reader-text">Search for:</span>
      <input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
    </label>
    <input class="widget-search__submit" type="submit" value="Search">
    <input type="hidden" name="sites" value="https://jonathanpoelen.github.io/" />
  </form>
</div>

	
<div class="widget-recent widget" id="main-menu">
  <h4 class="widget__title"><i class="fas fa-file-text-o" aria-hidden="true"></i> Articles récents</h4>
  <div class="widget__content">
    <ul class="widget__list">
      <li class="widget__item"><a class="widget__link" href="/2019/01/grep-sed-awk-sort...-non-zsh/">Grep, sed, awk, sort... Non ! Zsh</a></li>
      <li class="widget__item"><a class="widget__link" href="/2018/12/presque-toujours-stdmove/">Presque toujours std::move</a></li>
      <li class="widget__item"><a class="widget__link" href="/2018/11/meta-function-et-continuation/">Méta-function et continuation</a></li>
      <li class="widget__item"><a class="widget__link" href="/2018/11/simuler-une-vtable-sans-fonction-virtuelle/">Simuler une vtable sans fonction virtuelle</a></li>
      
      <li class="widget__item"><a class="widget__link widget__link__other" href="/archives">32 autres…</a></li>
    </ul>
  </div>
</div>
<div class="widget-recent widget">
  <h4 class="widget__title"><i class="fas fa-clock-o" aria-hidden="true"></i> Articles récemment mis à jour</h4>
  <div class="widget__content">
    <ul class="widget__list">

    </ul>
  </div>
</div>

	
<div class="widget-categories widget">
  <h4 class="widget__title"><i class="fas fa-folder-o" aria-hidden="true"></i> Catégories</h4>
  <div class="widget__content">
    <ul class="widget__list">
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour C&#43;&#43;">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/c&#43;&#43;">C&#43;&#43; (23)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Script-Shell">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/script-shell">Script-Shell (6)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Accessibilite-Web">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/accessibilite-web">Accessibilite-Web (2)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Javascript">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/javascript">Javascript (2)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Zsh">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/zsh">Zsh (2)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Make">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/make">Make (1)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Shell">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/shell">Shell (1)</a>
      </li>
      <li class="widget__item">
        <a class="rss-link" href="/categories/index.xml" type="application/rss+xml" title="Flux RSS pour Sqlite">
          &nbsp;
          <i class="fas fa-rss" aria-hidden="true"></i>
          <span class="sr-only link-alt">Flux RSS</span>&nbsp;
        </a>
        <a class="widget__link" href="/categories/sqlite">Sqlite (1)</a>
      </li>
    </ul>
  </div>
</div>

	
	

</aside>

  <main class="main-content list content" role="main" id="main-content">
        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="grep-sed-awk-sort...-non-zsh"><span>
        &nbsp;
        <a href="#presque-toujours-stdmove"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Presque toujours std::move"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/">Grep, sed, awk, sort... Non ! Zsh</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#presque-toujours-stdmove">Article précédent: Presque toujours std::move</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2019-01-28T22:45:03">28 janvier 2019
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/zsh" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>zsh</a>, <a class="meta-categories__link" href="/categories/shell" rel="category">shell</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>5 minutes ;
  <a href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#ffdfc9a9c9da44f723144c5e62cea7d4-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Depuis plusieurs années maintenant, j&rsquo;utilise Zsh comme shell par défaut. Et par la force des choses, il m&rsquo;arrive de taper des commandes zsh, de faire des boucles zsh, de penser zsh. Bref, de coder en zsh. Bien que le langage a des inconvénients, il possède de nombreuses fonctionnalités qui recouvrent celles de certains utilitaires Unix.</p>

<p>Les gros avantage d&rsquo;utiliser zsh plutôt que les commandes Unix sont au nombre de 3:</p>

<ul>
<li>Pas de post traitement pour mettre le résultat d&rsquo;une commande dans une variable.</li>
<li>Beaucoup plus rapide que lancer une commande. La création de process prend du temps et se ressent dans une boucle.</li>
<li>Écrire en 3 lettres ce qu&rsquo;on peut faire en 32. C&rsquo;est-à-dire frimer ;).</li>
</ul>

<p>Il y a aussi des inconvénients:</p>

<ul>
<li>Moins lisible, surtout lorsque l&rsquo;on remplace une suite de pipe comme <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">aaa <span class="p">|</span> bbb <span class="p">|</span> ccc</code></span>. Mais on peut simplifier avec des variables intermédiaires.</li>
<li>Peut-être plus lent lorsqu&rsquo;il y a beaucoup de texte à manipuler. En gros, faire un grep d&rsquo;un fichier de 1000 lignes est plus lent qu&rsquo;avec zsh, mais plus rapide si le fichier fait 100000 lignes, car zsh ne travaille pas par flux.</li>
</ul>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#syntaxe-de-base"><h2 id="syntaxe-de-base">Syntaxe de base</h2></a>

<p>Le <code>man</code> de zsh fait plus de 5 fois celui de bash. Le manuel est tellement gros qu&rsquo;il est divisé en 16 parties + un <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">man zshall</code></span> pour les afficher tous. Difficile de tout mettre en 1 article alors je me contente de certaines parties de <code>zshexpn</code> (zsh expansion and substitution). Parmi celles utilisées ici il y a les options d&rsquo;expansion de paramètres (<span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(@)x</span><span class="si">}</span></code></span>) et les modificateurs (<span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">x</span><span class="p">:</span><span class="nv">h</span><span class="si">}</span></code></span> ou <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$x</span>:h</code></span>). Il existe un pdf compilant les options et syntaxe de zsh: <a href="http://www.bash2zsh.com/zsh_refcard/refcard.pdf">http://www.bash2zsh.com/zsh_refcard/refcard.pdf</a>.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#lire-un-fichier"><h3 id="lire-un-fichier">Lire un fichier</h3></a>

<p>Voici comment les zsh peuvent lire un fichier et mettre chaque ligne dans un tableau grâce aux extensions de paramètres:</p>
<div class="highlight"><pre class="chroma"><code class="language-zsh" data-lang="zsh"><span class="nv">contents</span><span class="o">=</span><span class="k">$(</span>&lt;file<span class="k">)</span> <span class="c1"># lire un fichier</span>
<span class="nv">contents</span><span class="o">=</span><span class="k">$(</span>&lt;file1 &lt;file2<span class="k">)</span> <span class="c1"># lire 2 fichiers</span>
<span class="nv">contents</span><span class="o">=</span><span class="k">$(</span>&lt;file <span class="p">;</span> ls<span class="k">)</span> <span class="c1"># lire un fichier et le retour de commande `ls`</span>

<span class="nv">lines</span><span class="o">=(</span> <span class="si">${</span><span class="p">(f)contents</span><span class="si">}</span> <span class="o">)</span> <span class="c1"># tableau sans ligne vide</span>
<span class="nv">lines</span><span class="o">=(</span> <span class="si">${</span><span class="p">(s:</span><span class="se">\n</span><span class="p">:)contents</span><span class="si">}</span> <span class="o">)</span> <span class="c1"># équivalent</span>
<span class="nv">lines</span><span class="o">=(</span> <span class="s2">&#34;</span><span class="si">${</span><span class="p">(@f)contents</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">)</span> <span class="c1"># tableau avec toutes les lignes (il faut les quotes et @)</span>

<span class="nv">lines</span><span class="o">=(</span> <span class="si">${</span><span class="p">(f)</span><span class="k">$(</span>&lt;file<span class="k">)</span><span class="si">}</span> <span class="o">)</span> <span class="c1"># forme condensée du premier cas</span>

<span class="nb">echo</span> <span class="si">${</span><span class="p">(j:</span><span class="se">\n</span><span class="p">:)lines</span><span class="si">}</span> <span class="c1"># concatène les lignes avec \n</span>
<span class="c1"># ou</span>
<span class="nb">echo</span> <span class="si">${</span><span class="p">(F)lines</span><span class="si">}</span>

<span class="c1"># affiche chaque ligne d&#39;un fichier dans des crochets</span>
<span class="nb">echo</span> <span class="s2">&#34;[</span><span class="si">${</span><span class="p">(j:]</span><span class="se">\n</span><span class="p">[:)</span><span class="s2">&#34;</span><span class="si">${</span><span class="p">(@f)</span><span class="k">$(</span>&lt;file<span class="k">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="si">}</span><span class="s2">]&#34;</span></code></pre></div>
<p>Il y a encore de nombreux paramètres qui peuvent être trouvés dans le manuel ou via l&rsquo;auto-complétion de zsh. Aussi, pour simplifier les exemples qui suivront, j&rsquo;utiliserai directement les variables <code>contents</code> et <code>lines</code>.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#glob-et-glob-étendu"><h3 id="glob-et-glob-étendu">Glob et glob étendu</h3></a>

<p>L&rsquo;une des grandes forces de zsh réside dans le globbing. Il ne se restreint pas qu&rsquo;à la recherche de fichier, mais peut aussi s&rsquo;appliquer sur les éléments d&rsquo;un tableau ou des chaînes pour filtrer ou transformer. En plus de <code>*</code> et <code>?</code>, zsh comprend <code>[...]</code>, <code>[^...]</code> et <code>&lt;x-y&gt;</code> pour un nombre entre <code>x</code> et <code>y</code> inclu (<code>&lt;-&gt;</code> pour n&rsquo;importe quel digit).</p>

<p>Avec le glob étendu (<code>setopt extendedglob</code>) on possède alors un équivalent des regex:</p>

<ul>
<li><code>x#</code> 0 ou plus de <code>x</code></li>
<li><code>x##</code> 1 ou plus de <code>x</code></li>
<li><code>x~y</code> exclut <code>y</code> de <code>x</code></li>
<li><code>^x</code> tous sauf <code>x</code></li>
<li><code>(#s)</code> début (équivalent de <code>^</code> des regex)</li>
<li><code>(#e)</code> fin (équivalent de <code>$</code> des regex)</li>
</ul>

<p>Ainsi que la syntaxe ksh si activée</p>

<table>
<thead>
<tr>
<th>ksh-like</th>
<th>glob operators</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">@<span class="o">(</span>...<span class="o">)</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">(</span>...<span class="o">)</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">*<span class="o">(</span>...<span class="o">)</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">(</span>...<span class="o">)</span>#</code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">+<span class="o">(</span>...<span class="o">)</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">(</span>...<span class="o">)</span><span class="c1">##</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">?<span class="o">(</span>...<span class="o">)</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">(</span><span class="p">|</span>...<span class="o">)</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">!<span class="o">(</span>...<span class="o">)</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">(</span>^<span class="o">(</span>...<span class="o">))</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#équivalent-des-commandes-unix"><h2 id="équivalent-des-commandes-unix">Équivalent des commandes *Unix</h2></a>

<p>Maintenant que la petite introduction syntaxique est faite, on peut s&rsquo;attaquer au remplacement des commandes systèmes. Bien sûr, toutes les options d&rsquo;une commande ne peuvent pas être simulées facilement avec zsh, mais je présente ici l&rsquo;essentiel. Je précise que les commandes bash ont implicitement <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="o">&lt;&lt;&lt;</span><span class="nv">$contents</span></code></span> comme flux de lecture et que le résultat des commandes zsh est fait avec un <code>echo</code>.</p>

<p>Je conseille aussi le petit <a href="https://github.com/zdharma/Zsh-100-Commits-Club/blob/master/Zsh-Native-Scripting-Handbook.adoc">Zsh Native Scripting Guide</a>.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#grep"><h3 id="grep">grep</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">grep <span class="s1">&#39;Alligator&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(M)lines:#*Alligator*</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">grep -v <span class="s1">&#39;Alligator&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">:#*Alligator*</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">grep <span class="s1">&#39;^Alligator .* Alligator$&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(M)lines:#Alligator * Alligator</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">grep -i <span class="s1">&#39;alligator&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(M)lines:#(#i)*alligator*</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">grep -m1 <span class="s1">&#39;aligator&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">[(r)*aligator*]</span><span class="si">}</span></code></span></td>
</tr>
</tbody>
</table>

<p><code>(#i)</code> n&rsquo;est utilisable qu&rsquo;avec <code>setopt extendedglob</code> et peut s&rsquo;appliquer sur un groupe seulement de caractère (i.e. <code>((#i)a)lbator</code>). Il existe l&rsquo;option inverse: <code>#I</code>. Ainsi que <code>#l</code> qui fait une recherche insensible à la case pour les lettres minuscules du pattern, et en majuscule pour celles en majuscule dans le pattern.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#agrep"><h3 id="agrep">agrep</h3></a>

<p><code>agrep</code> pour &laquo;&nbsp;approximate grep&nbsp;&raquo;. C&rsquo;est un <code>grep</code> qui autorise une marge d&rsquo;erreur dans la recherche. Zsh possède une option de glob qui fait à peu près la même chose: <code>(#a3)</code> pour une recherche avec 3 erreurs.</p>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">agrep -3 <span class="s1">&#39;alligator&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(M)lines:#*((#a3)alligator)*</span><span class="si">}</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#sed"><h3 id="sed">sed</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed <span class="s1">&#39;3,6!d&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$lines</span><span class="o">[</span><span class="m">3</span>,5<span class="o">]</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed s/aligator/crocodile/</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">contents</span><span class="p">/aligator/crocodile</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed s/aligator/crocodile/g</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">contents</span><span class="p">//aligator/crocodile</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed <span class="s1">&#39;s/^aligator\*$/_/&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">:</span><span class="nv">s</span><span class="p">%aligator*%_</span><span class="si">}</span></code></span> ou <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">/(#s)aligator</span><span class="se">\*</span><span class="p">(#e)/_</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed <span class="s1">&#39;s/^\w\+$/[&amp;]/&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">:/(#m)[[:</span><span class="nv">alnum</span><span class="p">:]]##/[</span><span class="nv">$MATCH</span><span class="p">]</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sed -E <span class="s1">&#39;s/^(\w+) = (\w+)$/\2 = \1/&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">:/(#b)([[:</span><span class="nv">alnum</span><span class="p">:]]##) = ([[:</span><span class="nv">alnum</span><span class="p">:]]##)/</span><span class="nv">$match</span><span class="p">[2] = </span><span class="nv">$match</span><span class="p">[1]</span><span class="si">}</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#head"><h3 id="head">head</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">head -n3</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$lines</span><span class="o">[</span><span class="m">1</span>,3<span class="o">]</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#awk"><h3 id="awk">awk</h3></a>

<p>Pour celui-là, l&rsquo;entrée sera le texte ci-dessous. Le programme va coloriser le préfixe.</p>

<pre><code>info: un alligator dort sur le balcon
avertissement: l'alligator se réveille
erreur: l'alligator attaque
note: penser à investir dans une porte plus solide
</code></pre>

<table>
<thead>
<tr>
<th>awk</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-awk" data-lang="awk"><span class="nb">BEGIN</span> <span class="p">{</span>
  <span class="nx">colors</span><span class="p">[</span><span class="s2">&#34;erreur:&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;31&#34;</span>
  <span class="nx">colors</span><span class="p">[</span><span class="s2">&#34;avertissement:&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;33&#34;</span>
  <span class="nx">colors</span><span class="p">[</span><span class="s2">&#34;info:&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;35&#34;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">in</span> <span class="nx">colors</span><span class="p">)</span>
    <span class="nx">colorized</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;\033[&#34;</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="s2">&#34;m&#34;</span> <span class="nx">k</span> <span class="s2">&#34;\033[0m&#34;</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nx">s</span><span class="o">=</span><span class="nx">colorized</span><span class="p">[</span><span class="o">$</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">print</span> <span class="nx">s</span> <span class="kr">substr</span><span class="p">(</span><span class="o">$</span><span class="mi">0</span><span class="p">,</span> <span class="kr">length</span><span class="p">(</span><span class="o">$</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="kr">print</span> <span class="o">$</span><span class="mi">0</span>
<span class="p">}</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nb">declare</span> -A <span class="nv">colors</span><span class="o">=(</span>erreur: <span class="m">31</span> avertissement: <span class="m">33</span> info: <span class="m">35</span><span class="o">)</span>
<span class="nb">declare</span> -A colorized
<span class="k">for</span> k in <span class="si">${</span><span class="p">(k)colors</span><span class="si">}</span> <span class="p">;</span>
  <span class="nv">colorized</span><span class="o">+=(</span><span class="nv">$k</span> <span class="s2">&#34;\033[</span><span class="nv">$colors</span><span class="s2">[</span><span class="nv">$k</span><span class="s2">]m</span><span class="nv">$k</span><span class="s2">\033[0m&#34;</span><span class="o">)</span>

<span class="nb">echo</span> <span class="si">${</span><span class="p">(F)lines/(#m)(#s)[a-z]##:/</span><span class="si">${</span><span class="nv">colorized</span><span class="p">[</span><span class="nv">$MATCH</span><span class="p">]</span><span class="k">:-</span><span class="nv">$MATCH</span><span class="si">}}</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#find"><h3 id="find">find</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">find -name <span class="s1">&#39;*aligator*&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">**/*aligator*</code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">find -name <span class="s1">&#39;*aligator*&#39;</span> -a -not <span class="s1">&#39;*crocodile*&#39;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">**/*aligator*~*crocodile*</code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">find -type d</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">**/*<span class="o">(</span>/<span class="o">)</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">find -type l</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">**/*<span class="o">(</span>@<span class="o">)</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">find -atime <span class="m">3</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">**/*<span class="o">(</span>a3<span class="o">)</span></code></span></td>
</tr>
</tbody>
</table>

<p>Bon, vous l&rsquo;aurez compris, zsh permet de nombreux filtres dans la recherche de fichier. Il peut trier la recherche par date, nom, groupe, etc ou même via une fonction personnalisée.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#sort"><h3 id="sort">sort</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sort</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(o)lines</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sort -n</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(on)lines</span><span class="si">}</span></code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">sort -rn</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="p">(On)lines</span><span class="si">}</span></code></span></td>
</tr>
</tbody>
</table>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#manipulation-de-chemin"><h3 id="manipulation-de-chemin">Manipulation de chemin</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">dirname <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">&#34;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$0</span>:h</code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">basename <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">&#34;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$0</span>:t</code></span></td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">realpath <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">&#34;</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nv">$0</span>:P</code></span></td>
</tr>
</tbody>
</table>

<p>Il y en a évidemment d&rsquo;autres.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#cut"><h3 id="cut">cut</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh">cut -d: -f2,1</code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="si">${</span><span class="nv">lines</span><span class="p">/(#m)*/</span><span class="k">$((</span><span class="o">)</span> <span class="o">{</span> <span class="nb">echo</span> <span class="nv">$2</span>:<span class="nv">$1</span> <span class="o">}</span> <span class="si">${</span><span class="p">(s:</span><span class="nv">b</span><span class="p">:)MATCH</span><span class="si">}</span><span class="o">)}</span></code></span></td>
</tr>
</tbody>
</table>

<p>Mais une boucle serait mieux ici.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/#printf"><h3 id="printf">printf</h3></a>

<table>
<thead>
<tr>
<th>bash</th>
<th>zsh</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nb">printf</span> <span class="s1">&#39;%04d&#39;</span> <span class="m">42</span></code></span></td>
<td><span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nb">echo</span> <span class="si">${</span><span class="p">(l:</span><span class="nv">4</span><span class="p">::</span><span class="nv">0</span><span class="p">:)</span><span class="si">${</span><span class="k">:-</span><span class="nv">42</span><span class="si">}}</span></code></span> ou <span class="inlinecode highlight"><code class="language-zsh" data-lang="zsh"><span class="nb">echo</span> <span class="si">${</span><span class="p">(l:</span><span class="nv">4</span><span class="p">::</span><span class="nv">0</span><span class="p">:)</span><span class="nv">$n</span><span class="si">}</span></code></span></td>
</tr>
</tbody>
</table>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2019-01-28T22:45:03">28 janvier 2019
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/zsh" rel="category">zsh</a>, <a class="meta-categories__link" href="/categories/shell" rel="category">shell</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2019/01/grep-sed-awk-sort...-non-zsh/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="ffdfc9a9c9da44f723144c5e62cea7d4-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=grep-sed-awk-sort...-non-zsh&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f&amp;title=grep-sed-awk-sort...-non-zsh" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2019%2f01%2fgrep-sed-awk-sort...-non-zsh%2f&amp;name=grep-sed-awk-sort...-non-zsh" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="presque-toujours-stdmove"><span>
        <a href="#grep-sed-awk-sort...-non-zsh"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Grep, sed, awk, sort... Non ! Zsh"></i></a>
        <a href="#m%25C3%25A9ta-function-et-continuation"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Méta-function et continuation"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/12/presque-toujours-stdmove/">Presque toujours std::move</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#grep-sed-awk-sort...-non-zsh">Article suivant: Grep, sed, awk, sort... Non ! Zsh</a><br/>
        <a href="#m%25C3%25A9ta-function-et-continuation">Article précédent: Méta-function et continuation</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-12-09T13:11:29">09 décembre 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>2 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/12/presque-toujours-stdmove/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#f5c829c4a296c3dc8dd76923c74b4885-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Le principe de <code>std::move</code> est de &laquo;&nbsp;déplacer<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>&nbsp;&raquo; un objet qui n&rsquo;est plus utilisé dans l&rsquo;objectif de décharger la responsabilité dans une autre variable ou d&rsquo;utiliser le constructeur de déplacement à la place de celui de copie.</p>

<p>Pour avoir de meilleures performances, il est tentant de le mettre partout lorsque la variable n&rsquo;est plus utilisée. Un constructeur de déplacement sera toujours préférable au constructeur de copie, pourquoi s&rsquo;en priver ?</p>

<p><em>Rire sarcastique.</em></p>

<p>Parce qu&rsquo;il est possible de &laquo;&nbsp;déplacer&nbsp;&raquo; les valeurs sans passer le constructeur !</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/12/presque-toujours-stdmove/#du-déplacement-sans-std-move"><h2 id="du-déplacement-sans-std-move">Du &laquo;&nbsp;déplacement&nbsp;&raquo; sans std::move</h2></a>

<p>C&rsquo;est fort du roquefort ! Pas de constructeur, pas de <code>std::move</code>, mais un objet qui se déplace quand même. On croirait faire de la magie !</p>

<p><code>std::move</code> va forcer l&rsquo;appel à un constructeur de déplacement alors que le compilateur a les moyens &ndash; et même l&rsquo;obligation &ndash; de le faire pour nous. Ou mieux, bypasser tous les constructeurs et mettre la valeur directement là où il faut. On parle d&rsquo;<a href="https://en.cppreference.com/w/cpp/language/copy_elision">élision par copie</a> ou de (N)RVO (Named Return Value Optimization). Sauf que <code>std::move</code> bloque ces optimisations.</p>

<p>Dans le cas de l&rsquo;élision de copie, le compilateur construit directement les paramètres de type T (un type sans référence) lorsqu&rsquo;on utilise un temporaire.</p>

<p>Avec <code>void foo(T)</code>, il faut faire <code>foo(T{...})</code> et non pas <code>foo(std::move(T({...})</code>. Comme on ne fait pas <code>T x = std::move(T{...})</code>, mais <code>T x = T{...}</code> (on peut faire <code>T x{}</code>, c&rsquo;est pour l&rsquo;exemple)</p>

<p>Les temporaires peuvent aussi exister depuis l&rsquo;appel à une fonction qui retourne <code>T</code>.</p>

<p>Avec <code>T bar()</code>, il faut faire <code>foo(bar())</code>, et non pas <code>foo(std::move(bar()))</code>.</p>

<p>La (N)RVO est une optimisation qui fonctionne sur le même principe au niveau de la valeur de retour.</p>

<p>On n&rsquo;écrit pas <code>T bar() { return std::move(T{...}); }</code>, mais <code>T bar() { return T{...}; }</code>.</p>

<p>Le compilateur possède aussi un comportement spécial pour la variable locale retournée: celle-ci doit être déplacée si possible. Et si possible, on optimise avec une élision.</p>

<p>On écrit</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">T</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">x</span><span class="p">;</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>À la place de</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">T</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">x</span><span class="p">;</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Au final, les seuls moments où <code>std::move</code> devrait être utilisé, sont</p>

<ul>
<li>Pour transférer une variable de type référence (lvalue ou rvalue) en la forçant en rvalue.</li>
<li>Pour passer une variable de type plein (sans référence) à une autre fonction.</li>
</ul>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">std::move n&rsquo;est qu&rsquo;un <code>static_cast&lt;T&amp;&amp;&gt;</code>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-12-09T13:11:29">09 décembre 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/12/presque-toujours-stdmove/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="f5c829c4a296c3dc8dd76923c74b4885-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=presque-toujours-stdmove&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f&amp;title=presque-toujours-stdmove" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f12%2fpresque-toujours-stdmove%2f&amp;name=presque-toujours-stdmove" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="m%C3%A9ta-function-et-continuation"><span>
        <a href="#presque-toujours-stdmove"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Presque toujours std::move"></i></a>
        <a href="#simuler-une-vtable-sans-fonction-virtuelle"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Simuler une vtable sans fonction virtuelle"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/">Méta-function et continuation</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#presque-toujours-stdmove">Article suivant: Presque toujours std::move</a><br/>
        <a href="#simuler-une-vtable-sans-fonction-virtuelle">Article précédent: Simuler une vtable sans fonction virtuelle</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-11-08T18:56:13">08 novembre 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>4 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#c02325acf4c9cbb757454bfd7c056e30-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>J&rsquo;ai pas mal bossé avec des bibliothèques de méta-programmation, et une que j&rsquo;apprécie particulièrement est <a href="https://github.com/kvasir-io/mpl">Kvasir.Mpl</a>. Son originalité réside dans le support des <a href="https://fr.wikipedia.org/wiki/Continuation">continuations</a> et &ndash;parce que cela va bien de paire,&ndash; l&rsquo;évaluation paresseuse ainsi que des algorithmes pensés pour manipuler des packs (template variadique) plutôt que des listes de type (<code>list&lt;Ts...&gt;</code>).</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/#continuation"><h2 id="continuation">Continuation</h2></a>

<p>Chaque algorithme dispose d&rsquo;un paramètre qui décrit l&rsquo;étape suivante du traitement, c&rsquo;est la continuation. En shell ou dans des bibliothèques comme <a href="https://github.com/ericniebler/range-v3">rangev3</a>, les continuations se font avec l&rsquo;opérateur <code>|</code>. Par exemple <code>grep x | wc -l</code> ou <code>filter(is_odd) | take(6)</code>. Il n&rsquo;est pas possible d&rsquo;utiliser <code>|</code> avec des templates alors la continuation est un paramètre ajouté à l&rsquo;algorithme. En chaînant les continuations, on construit un nouvel algorithme qui s&rsquo;utilise avec <code>call&lt;algo, xs...&gt;</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// `C` pour continuation
</span><span class="c1"></span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">C</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">add_const</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">C</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">add_lvalue_reference</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">C</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">add_const_lvalue_reference</span> <span class="o">=</span> <span class="n">add_const</span><span class="o">&lt;</span><span class="n">add_lvalue_reference</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;&gt;</span><span class="p">;</span> <span class="c1">// un chaînage
</span><span class="c1"></span></code></pre></div>


<p>Les continuations limitent drastiquement le recours aux &laquo;&nbsp;lambdas&nbsp;&raquo;. Dans d&rsquo;autres bibliothèques du genre, <code>add_const_lvalue_reference</code> s&rsquo;écrirait <code>lambda&lt;add_lvalue_reference, lambda&lt;add_const, _&gt;&gt;</code> ce qui est beaucoup moins glamour.</p>

<p>Dans des algorithmes du type transformation l&rsquo;impact sur la lecture du code est immédiat:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">transform</span><span class="o">&lt;</span><span class="n">lambda</span><span class="o">&lt;</span><span class="n">next</span><span class="p">,</span> <span class="n">lambda</span><span class="o">&lt;</span><span class="n">times</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">&gt;</span>
<span class="c1">// vs
</span><span class="c1"></span><span class="n">call</span><span class="o">&lt;</span><span class="n">transform</span><span class="o">&lt;</span><span class="n">times</span><span class="o">&lt;</span><span class="n">next</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="cm">/*C=listify*/</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">&gt;</span>
</code></pre></div>
<p>Qui se traduit par la construction d&rsquo;une nouvelle liste avec la formule <code>(x*y)+1</code>.</p>

<p>Ce code met bien en évidence un autre aspect des continuations: la lecture du code se fait de gauche à droite alors que les lambdas se lisent de droite à gauche et oblige le lecteur à faire des allers/retours pour suivre le flux de code.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">transform</span><span class="o">&lt;</span><span class="n">lambda</span><span class="o">&lt;</span><span class="n">next</span><span class="p">,</span> <span class="n">lambda</span><span class="o">&lt;</span><span class="n">times</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">&gt;</span>
 <span class="cm">/* 1 */</span>       <span class="cm">/* 3 */</span>       <span class="cm">/* 2 */</span>
<span class="n">call</span><span class="o">&lt;</span><span class="n">transform</span><span class="o">&lt;</span><span class="n">times</span><span class="o">&lt;</span><span class="n">next</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="cm">/*C=listify*/</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="o">&gt;</span>
      <span class="cm">/* 1 *//* 2 *//* 3 */</span>      <span class="cm">/* 4 */</span>
</code></pre></div>
<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/#méta-fonction"><h2 id="méta-fonction">Méta-fonction</h2></a>

<p>Au niveau de kvasir, une méta-fonction est un type qui possède un membre template nommé <code>f</code>. Tous les algorithmes de kvasir sont des méta-fonctions et l&rsquo;appel se fait avec <code>call&lt;metafunc, param1, param2,...&gt;</code>. Si on complète <code>add_const</code> et <code>add_lvalue_reference</code> plus haut, cela donne:</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">call</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">F</span><span class="o">::</span><span class="k">template</span> <span class="n">f</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">C</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">add_const</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">C</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">add_lvalue_reference</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;&gt;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Il ne reste qu&rsquo;une dernière étape, la continuation finale lorsqu&rsquo;il n&rsquo;y a plus rien à faire. Les plus utilisés sont au nombre de 2 et servent de valeur par défaut à l&rsquo;ensemble des algorithmes, j&rsquo;ai nommé <code>identity</code> et <code>listify</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="n">identity</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">...</span><span class="o">&gt;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">list</span> <span class="p">{};</span>

<span class="k">struct</span> <span class="n">listify</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/#c-est-beau-c-est-propre"><h2 id="c-est-beau-c-est-propre">C&rsquo;est beau, c&rsquo;est propre</h2></a>

<p>Il y a quelques jours, après mon petit passage quotidien dans libstdc++ et en regardant <code>std::decay</code>, je me suis dit <del>c&rsquo;est beau, c&rsquo;est propre</del> qu&rsquo;il faudrait comparer avec une implémentation qui utilise les concepts de kvasir.</p>

<p>Voici en l&rsquo;état la version fournie avec gcc-8.2:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Decay trait for arrays and functions, used for perfect forwarding
</span><span class="c1">// in make_pair, make_tuple, etc.
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Up</span><span class="p">,</span>
     <span class="kt">bool</span> <span class="n">_IsArray</span> <span class="o">=</span> <span class="n">is_array</span><span class="o">&lt;</span><span class="n">_Up</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
     <span class="kt">bool</span> <span class="n">_IsFunction</span> <span class="o">=</span> <span class="n">is_function</span><span class="o">&lt;</span><span class="n">_Up</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">__decay_selector</span><span class="p">;</span>

<span class="c1">// NB: DR 705.
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Up</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">__decay_selector</span><span class="o">&lt;</span><span class="n">_Up</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="o">&gt;</span>
  <span class="p">{</span> <span class="k">typedef</span> <span class="k">typename</span> <span class="n">remove_cv</span><span class="o">&lt;</span><span class="n">_Up</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">__type</span><span class="p">;</span> <span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Up</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">__decay_selector</span><span class="o">&lt;</span><span class="n">_Up</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="o">&gt;</span>
  <span class="p">{</span> <span class="k">typedef</span> <span class="k">typename</span> <span class="n">remove_extent</span><span class="o">&lt;</span><span class="n">_Up</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="n">__type</span><span class="p">;</span> <span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Up</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">__decay_selector</span><span class="o">&lt;</span><span class="n">_Up</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="o">&gt;</span>
  <span class="p">{</span> <span class="k">typedef</span> <span class="k">typename</span> <span class="n">add_pointer</span><span class="o">&lt;</span><span class="n">_Up</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">__type</span><span class="p">;</span> <span class="p">};</span>

<span class="c1">/// decay
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">_Tp</span><span class="o">&gt;</span>
  <span class="k">class</span><span class="err"> </span><span class="nc">decay</span>
  <span class="p">{</span>
    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">_Tp</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">__remove_type</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">__decay_selector</span><span class="o">&lt;</span><span class="n">__remove_type</span><span class="o">&gt;::</span><span class="n">__type</span> <span class="n">type</span><span class="p">;</span>
  <span class="p">};</span>
</code></pre></div>
<p>En réalité, ce qui m&rsquo;a particulièrement tiqué se situe dans la déclaration de <code>__decay_selector</code>: <code>is_array</code> et <code>is_function</code> sont toujours évaluées avec <code>_Up</code> et il faut écrire plusieurs spécialisations.</p>

<p>L&rsquo;idée du sélecteur est un bon concept et se remplace facilement par une suite de conditions:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// ce que fait plus ou moins libc++ de llvm
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">__decay_selector</span> <span class="o">=</span> <span class="n">conditional</span><span class="o">&lt;</span>
  <span class="n">is_array_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">remove_extent_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;*</span><span class="p">,</span>
  <span class="n">conditional_t</span><span class="o">&lt;</span>
    <span class="n">is_function_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">add_pointer_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">remove_cv_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="o">&gt;</span>
<span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>
<p>Qui engendre son lot de problèmes: en plus des 2 traits précédents, <code>remove_extent</code>, <code>add_pointer</code> et <code>remove_cv</code> sont toujours déclarés avec <code>T</code>. Cela ne pose pas de réel problème ici &ndash; à part le temps de compilation&ndash;, malheureusement, dans certaines situations les branches ne doivent s&rsquo;évaluer qu&rsquo;en fonction du prédicat et les traits de la stl ne le permettent pas sans ajouter des intermédiaires.</p>

<p>Mais les continuations changent tout puisque les méta-fonctions ne sont évaluées que pour la branche qui respecte le prédicat. Ainsi, <code>remove_extent&lt;T&gt;</code> ne sera pas instancié lorsque <code>is_array_v&lt;T&gt;</code> est faux ce qui rend les continuations très facilement composables.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">decay</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span>
    <span class="n">if_</span><span class="o">&lt;</span>
      <span class="n">cfl</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_array</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">cfe</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_extent</span><span class="p">,</span> <span class="n">cfe</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">add_pointer</span><span class="o">&gt;&gt;</span><span class="p">,</span>
      <span class="n">if_</span><span class="o">&lt;</span>
        <span class="n">cfl</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_function</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">cfe</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">add_pointer_impl</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="n">cfe</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_cv</span><span class="o">&gt;</span>
      <span class="o">&gt;</span>
    <span class="o">&gt;</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">remove_reference_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Avec l&rsquo;implémentation de <code>if_</code>:</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="n">B</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">conditional</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">P</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">TC</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">FC</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">if_</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span><span class="n">call</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">conditional</span><span class="o">&lt;</span><span class="n">call</span><span class="o">&lt;</span><span class="n">P</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TC</span><span class="p">,</span> <span class="n">FC</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">...</span><span class="o">&gt;</span> <span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">C</span> <span class="o">=</span> <span class="n">identity</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">cfl</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">F</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">...</span><span class="o">&gt;</span> <span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">C</span> <span class="o">=</span> <span class="n">identity</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">cfe</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">call</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="n">F</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="n">B</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">conditional</span>
  <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;&gt;</span>
  <span class="k">struct</span> <span class="n">conditional</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span>
  <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">f</span> <span class="o">=</span> <span class="n">U</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>


<p>L&rsquo;ensemble des sources se trouvent sur <a href="https://github.com/jonathanpoelen/jonathanpoelen.github.io/tree/source/resources/metafunc_continuation/decay.cpp">github</a>
.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-11-08T18:56:13">08 novembre 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/11/meta-function-et-continuation/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="c02325acf4c9cbb757454bfd7c056e30-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=m%25C3%25A9ta-function-et-continuation&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f&amp;title=m%25C3%25A9ta-function-et-continuation" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fmeta-function-et-continuation%2f&amp;name=m%25C3%25A9ta-function-et-continuation" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="simuler-une-vtable-sans-fonction-virtuelle"><span>
        <a href="#m%25C3%25A9ta-function-et-continuation"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Méta-function et continuation"></i></a>
        <a href="#comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Comparaison de différentes implémentations de mp_index_of"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/">Simuler une vtable sans fonction virtuelle</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#m%25C3%25A9ta-function-et-continuation">Article suivant: Méta-function et continuation</a><br/>
        <a href="#comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of">Article précédent: Comparaison de différentes implémentations de mp_index_of</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-11-01T20:42:09">01 novembre 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>5 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#442b3694da91a9866c991b248ee3f410-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>La <code>vtable</code> est le mécanisme interne utilisé par C++ pour implémenter les fonctions virtuelles. Lorsqu&rsquo;une classe possède une fonction virtuelle, un pointeur sur la <code>vtable</code> (virtual table) est automatiquement réservé par le compilateur. Cette table contient des pointeurs de fonction sur l&rsquo;ensemble des fonctions virtuelles de la classe et chaque classe dérivée possède sa propre <code>vtable</code>.</p>

<p>Pour une classe de base implémentant une fonction <code>foo</code> virtuelle comme ci-dessous, l&rsquo;utilisation de <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">obj</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">(</span><span class="cm">/*params...*/</span><span class="p">)</span>
</code></span> va être remplacé par quelque chose proche de <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">cast</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">__vtable</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">obj</span><span class="cm">/*, params...*/</span><span class="p">)</span>
</code></span>.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="n">Base</span>
<span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">foo</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>Chaque classe dérivée qui ajoute des fonctions virtuelles réserve des cases supplémentaires dans son tableau. Le compilateur se basant sur les types utilisés pour garantir la validité des indices.</p>

<p>Ce fonctionnement est très économique : un pointeur pour chaque instance d&rsquo;une classe et une vtable en lecture seule par classe. C&rsquo;est également très facile d&rsquo;ajouter de nouvelles tables, y compris dynamiquement par le chargement de bibliothèque. Mais il y a aussi des inconvénients comme une fragmentation mémoire au niveau de la position des tables et un double déréférencement pour accéder au pointeur de fonction.</p>

<p>Pour la suite on se base sur une interface avec une fonction draw: <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">draw</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span>
</code></span> et 2 objets ce qu&rsquo;il a de plus classique: <code>Rect</code> et <code>Circle</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-hpp" data-lang="hpp"><span class="k">struct</span> <span class="n">Rect</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="n">draw</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Rect</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Circle</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="n">draw</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Circle</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>


<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/#une-vtable-à-la-mano"><h2 id="une-vtable-à-la-mano">Une vtable à la mano</h2></a>

<p>Notre vtable va contenir des pointeurs de fonction. Le type commun d&rsquo;une majorité de pointeurs est <code>void*</code>. Sauf que les pointeurs de fonction sont une exception, il n&rsquo;est pas légal de les transformer en <code>void*</code> &ndash; même si en interne le compilateur peut se le permettre pour sa vtable. Par contre, on peut récupérer l&rsquo;adresse du pointeur de fonction pour avoir un pointeur de pointeur de fonction. Cela fait beaucoup de pointeurs et d&rsquo;indirections alors le tableau sera remplacé par un tuple, car finalement on connait exactement les types de fonction que contient la vtable.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">using</span> <span class="n">draw_func_type</span> <span class="o">=</span> <span class="kt">void</span><span class="p">(</span><span class="kt">void</span> <span class="k">const</span><span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span><span class="p">);</span>

<span class="k">using</span> <span class="n">drawable_vtable</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">draw_func_type</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">;</span>
</code></pre></div>


<p>Maintenant qu&rsquo;on a un type pour la vtable, il faut pouvoir la construire à partir de n&rsquo;importe quel type qui pourrait supporter cette interface.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="k">auto</span> <span class="n">draw_func_ptr</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">void</span> <span class="k">const</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">drawable_vtable</span> <span class="n">drawable_vtable_for</span><span class="p">{</span>
  <span class="n">draw_func_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="p">};</span>
</code></pre></div>


<p>Grâce à ses variables inline, on peut construire notre tableau très facilement. Il ne reste plus qu&rsquo;à faire un petit wrapper pour utiliser <code>Rect</code> et <code>Circle</code> indistinctement.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="n">Drawable</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">Drawable</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)</span>
  <span class="p">,</span> <span class="n">vtable</span><span class="p">(</span><span class="n">drawable_vtable_for</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
  <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">draw</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">vtable</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">obj</span><span class="p">;</span>
  <span class="n">drawable_vtable</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">vtable</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p><code>Drawable</code> pourrait contenir directement <code>Rect</code> ou <code>Circle</code> plutôt qu&rsquo;avoir un <code>void*</code>, mais pour supporter n&rsquo;importe quel type et être optimisé, il est préférable d&rsquo;utiliser <a href="https://akrzemi1.wordpress.com/2014/04/14/common-optimizations/">SBO (Small Buffer Optimization)</a> Dans une optique de simplification, la classe n&rsquo;accepte que des références et garde un pointeur. On peut la considérer comme une vue polymorphique.</p>

<p>Une petite démonstration de la chose:</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Drawable</span> <span class="n">drawable</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">drawable</span><span class="p">.</span><span class="n">draw</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Rect</span> <span class="n">rect</span><span class="p">;</span>
  <span class="n">Circle</span> <span class="n">circle</span><span class="p">;</span>

  <span class="n">draw</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span> <span class="c1">// affiche Rect
</span><span class="c1"></span>  <span class="n">draw</span><span class="p">(</span><span class="n">circle</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span> <span class="c1">// affiche Circle
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div>


<p>C&rsquo;est tout :).</p>

<p>Il est possible de rendre plus simple la déclaration de la classe <code>Drawable</code> avec des macros pour supprimer <sup>2</sup>&frasl;<sub>3</sub> du code, mais je passe mon tour.</p>

<p>Par contre, il y a peut-être moyen d&rsquo;avoir mieux pour la vtable.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/#une-vtable-par-type-vs-une-vtable-par-instance"><h2 id="une-vtable-par-type-vs-une-vtable-par-instance">Une vtable par type vs une vtable par instance</h2></a>

<p>Notre <code>Drawable</code> contient une référence sur la vtable qui est elle-même un tableau de 1 pointeur de fonction. Autant jeter la vtable et avoir directement le pointeur de fonction comme membre. C&rsquo;est plus direct et le code est plus court.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="n">Drawable</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">Drawable</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">obj</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">)</span>
  <span class="p">,</span> <span class="n">draw_func</span><span class="p">(</span><span class="n">draw_func_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
  <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">draw</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span>
  <span class="p">{</span>
    <span class="n">draw_func</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span><span class="o">*</span> <span class="n">obj</span><span class="p">;</span>
  <span class="n">draw_func_type</span><span class="o">*</span> <span class="n">draw_func</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Pour une classe qui ne possède qu&rsquo;une fonction polymorphique, le pointeur de fonction en membre est un peu plus efficace qu&rsquo;une vtable en évitant une indirection. <code>std::function</code> utilise le même principe en interne en plus de prendre l&rsquo;ownership de l&rsquo;objet. Prendre l&rsquo;ownership implique de mettre l&rsquo;objet en membre, si l&rsquo;objet prend trop de place, comme une lambda avec une grosse capture, alors elle déborde du tampon interne et une allocation dynamique est généralement effectuée. Pour un comportement plus proche des exemples ci-dessus qui prennent une référence sur les données, il existe <a href="https://github.com/Naios/function2#small-functor-optimization">fn2::function_view</a>.</p>

<p>Par contre, pour chaque fonction polymorphique, la classe doit contenir un pointeur de fonction ce qui augmente sa taille. Si cet objet est mis dans un vector, alors il y aura beaucoup de pointeurs similaires entre les valeurs et une vtable peut réduire drastiquement la mémoire allouée par le vecteur.</p>

<p>Il y a un dernier point qui n&rsquo;est pas visible avec les exemples du dessus : le comportement peut être dynamiquement modifié. C&rsquo;est-à-dire qu&rsquo;une instance peut décider de modifier le comportement d&rsquo;une de ses fonctions en la remplaçant (taper dans <code>draw_func</code>) sans avoir de variable d&rsquo;état. La fonction en cours d&rsquo;exécution représentant l&rsquo;état courant. C&rsquo;est un aspect de la <a href="https://fr.wikipedia.org/wiki/Programmation_orient%C3%A9e_prototype">programmation orientée prototype</a>.</p>

<p>Bien sûr, avec une vtable, modifier un des pointeurs impacte tous les objets y faisant référence.</p>

<p>Après, rien n&rsquo;empêche d&rsquo;avoir un comportement hybride, une vtable pour les fonctions communes, peu utilisées ou &laquo;&nbsp;lentes&nbsp;&raquo;, et un membre pour les fonctions polymorphiques qui doivent etre &laquo;&nbsp;rapides&nbsp;&raquo; d&rsquo;accès ou qui changent en court de route. Des projets tels <a href="https://github.com/ldionne/dyno">dyno</a> permettent cela.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/#la-méthode-du-gros-switch"><h2 id="la-méthode-du-gros-switch">La méthode du gros switch</h2></a>

<p>C&rsquo;est une méthode très bourrin et pas très adapté au C++. Elle consiste à connaître l&rsquo;ensemble des types utilisés pour une interface et de les associer à la fonction. Plus de vtable, plus d&rsquo;indirection, mais à la place un saut à base de switch. Le compilateur pourrait plus facilement inliner le code, mais on perd la posibilité de charger dynamiquement des bibliothèques.</p>

<p>Le problème, c&rsquo;est qu&rsquo;il faut centraliser manuellement toutes les instances au même endroit pour faire notre table de saut, car il n&rsquo;existe aucun moyen de récupérer &ndash; par exemple &ndash; toutes les instances d&rsquo;un trait <code>is_drawable</code>. Si le compilateur ne nous aide pas, cette solution n&rsquo;est pas facile à maintenir. On peut néanmoins passer par un générateur de source qui sélectionnerait à la manière d&rsquo;un <code>clang-query</code> tous les types pour générer complètement le corps de la fonction <code>Drawable::draw</code>.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-11-01T20:42:09">01 novembre 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/11/simuler-une-vtable-sans-fonction-virtuelle/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="442b3694da91a9866c991b248ee3f410-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=simuler-une-vtable-sans-fonction-virtuelle&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f&amp;title=simuler-une-vtable-sans-fonction-virtuelle" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f11%2fsimuler-une-vtable-sans-fonction-virtuelle%2f&amp;name=simuler-une-vtable-sans-fonction-virtuelle" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="comparaison-de-diff%C3%A9rentes-impl%C3%A9mentations-de-mp_index_of"><span>
        <a href="#simuler-une-vtable-sans-fonction-virtuelle"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Simuler une vtable sans fonction virtuelle"></i></a>
        <a href="#au-c%25C5%2593ur-dun-variant"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Au cœur d&#39;un variant"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/">Comparaison de différentes implémentations de mp_index_of</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#simuler-une-vtable-sans-fonction-virtuelle">Article suivant: Simuler une vtable sans fonction virtuelle</a><br/>
        <a href="#au-c%25C5%2593ur-dun-variant">Article précédent: Au cœur d&#39;un variant</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-10-01T18:28:21">01 octobre 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>18 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#acfe95c97195256c7843e5c852ec2097-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Dans l&rsquo;article précédent sur les variants, j&rsquo;ai fait une implémentation un peu spéciale de <code>index_of</code>. Je vais présenter une quinzaine d&rsquo;implémentations possibles et le coût de chacune sur le compilateur.</p>

<div class="InfoBox"><p><strong class="InfoBox-title">Info :</strong> L&rsquo;implémentation citée précédemment ne se retrouve pas ici car une forme récursive plus &laquo;&nbsp;classique&nbsp;&raquo; a les mêmes conséquences.</p></div>


<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#avant-propos"><h2 id="avant-propos">Avant-propos</h2></a>

<p>Toutes les implémentations de <code>mp_index_of&lt;T, Ts...&gt;</code> retournent un <code>std::integral_constant&lt;int, i&gt;</code> correspondant à l&rsquo;indice de <code>T</code> dans <code>Ts</code> ou <code>-1</code> si <code>T</code> n&rsquo;existe pas.</p>

<p>Clang possède des outils tel que <a href="http://plc.inf.elte.hu/templight/">templight</a>, mais il n&rsquo;y a pas d&rsquo;équivalent pour Gcc. Par conséquent, les tests sont faits avec <code>/usr/bin/time --format=&quot;%E %M&quot;</code> qui ressort le temps et la mémoire maximum utilisée par un programme.</p>

<p>Au niveau des options de compilation, <code>-fsyntax-only</code> permet de vérifier la validité d&rsquo;un code sans générer de fichier de sortie. <code>-std=c++17</code> est présent pour utiliser les plies, mais tous les algorithmes n&rsquo;en ont pas besoin. <code>-ftemplate-depth=n</code> et <code>-fconstexpr-depth=n</code> appliquent une profondeur limite dans la récursivité appliquée respectivement aux templates et aux fonctions constexpr. <code>-w</code> supprime tous les avertissements (tels que des macros non utilisés) pour éviter que des sorties inopportunes influencent la mesure.</p>

<p>Il y a 2 formes de test:</p>

<ul>
<li>ceux sur des listes contenant 2 types nommés <code>x</code> et <code>_</code> et</li>
<li>ceux sur des suites <code>i&lt;n&gt;</code> avec <code>n</code> un entier et <code>x</code>.</li>
</ul>

<p>Pour chaque test, <code>T</code> représente <code>x</code> et il peut être présent ou non dans <code>Ts</code>.</p>

<p>les valeurs de <code>Ts</code> sont présentées dans les légendes sous forme abrégée:</p>

<ul>
<li><code>[x*500]</code>: une liste de 500 <code>x</code>.</li>
<li><code>[_*250, x, _*249]</code>: une liste de 250 <code>_</code>, suivit de <code>x</code> et d&rsquo;une liste de <code>249</code> <code>_</code>.</li>
<li><code>[i{0..40}*150]</code>: uns suite de 150 <code>i0</code>, une autre de 150 <code>i1</code> et ainsi de suite jusqu&rsquo;à <code>i40</code>.</li>
<li><code>[i0..i{0..140}]</code>: une suite <code>[i0..i0]</code>, puis [i0..i1], etc jusqu&rsquo;à <code>[i0..i140]</code>.</li>
<li><code>[i{0..n},x,i{n-(n..0)..n}];n=100</code>: les suites <code>[i{0..100},x,i{100..100}]</code>,  <code>[i{1..100},x,i{99..100}]</code>, etc</li>
</ul>

<p>Les sources se trouvent sur <a href="https://github.com/jonathanpoelen/jonathanpoelen.github.io/tree/source/resources/mp_index_of">github</a>
 dans un même fichier cpp. Chacune des implémentations possède son propre namespace et des macros activent individuellement chaque test. <!--TODO dossier des graphes + zip/tar.gz--></p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#relation-temps-de-compilation-et-mémoire"><h2 id="relation-temps-de-compilation-et-mémoire">Relation temps de compilation et mémoire</h2></a>

<p>Dans du code utilisant la méta-programmation, le temps de compilation suit la même courbe que la mémoire. Plus une compilation est lente, plus la mémoire utilisée augmente allant jusqu&rsquo;à saturation.</p>

<p>Et la mémoire est fortement liée au nombre de types instanciés par le compilateur. Ici, il ne faut pas voir une instance comme une variable, mais comme la première création d&rsquo;un type. Par exemple, <code>index_of&lt;int, int&gt;</code> est une instance de type (ou d&rsquo;alias), <code>index_of&lt;int, int, int&gt;</code> une seconde instance, <code>index_of&lt;int, float&gt;</code> une troisième, etc. Chaque type construit s&rsquo;ajoute dans la mémoire du compilateur et l&rsquo;ensemble utilise de plus en plus de place. C&rsquo;est ainsi que le compilateur implémente naturellement la <a href="https://fr.wikipedia.org/wiki/M%C3%A9mo%C3%AFsation">mémoïsation</a> pour les templates.</p>

<p>Pour réduire le temps de compilation, il faut donc réduire le nombre de type instancié.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#la-récursivité"><h2 id="la-récursivité">La récursivité</h2></a>

<p>La première chose qu&rsquo;on apprend avec les variadiques, c&rsquo;est que les boucles se font avec de la récursivité en enlevant un par un les éléments. C&rsquo;est une forme très facile à écrire et à comprendre, mais qui crée beaucoup de types intermédiaires à l&rsquo;intérieur du compilateur.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive_ternary</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">First</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">First</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">First</span><span class="o">&gt;</span>
    <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Une implémentation avec ternaire récursive comme on peut la trouver dans le fichier variant de libstdc++. Elle souffre d&rsquo;un léger problème: il y a autant d&rsquo;instance de <code>_index_of</code> que d&rsquo;élément dans la liste, même si <code>T</code> se trouve en première position.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive_indexed</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">First</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">i</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">First</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">i</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">i</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>L&rsquo;indice courant se trouve en paramètre template et la récursion s&rsquo;arrête dès que <code>T</code> est trouvé. Seulement, l&rsquo;ajout de l&rsquo;indice en paramètre va dégrader la mémoïsation en créant plus de types que nécessaire.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">First</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">First</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Un mélange des 2 implémentations précédentes sans les inconvénients. En réalité, c&rsquo;est la forme la plus communément écrite.</p>

<!-- ./gen_graphs.py compiler=g++ algo=recursive,recursive_indexed,recursive_ternary legend='~[];~all;~[_*1400];~[_*700, x*700];~n*' -- rec_gcc -->

<p><img src="/post/mp_index_of/rec_gcc_time.png" alt="duré de compilation avec gcc de 3 implémentations récursives" /></p>

<p>Sans surprise, sur les 3 premiers tests, la version avec ternaire est à peu près stable quelle que soit la position de <code>x</code>, même s&rsquo;il semble qu&rsquo;évaluer la ternaire ralentisse un peu la compilation lorsque <code>x</code> se situe vers la fin.
Alors que les 2 autres implémentations sont beaucoup plus rapides lorsque <code>x</code> est au début pour rattraper progressivement la version ternaire. Sans que je sache l&rsquo;expliquer, la version avec index explose le compteur pour le test 3.</p>

<p>Comme la courbe de progression pour la version récursive classique n&rsquo;est pas linéaire, je déduis que le nombre d&rsquo;éléments dans un pack d&rsquo;argument influence le temps de compilation. Il y a ±600ms de différence pour parcourir les 700 premiers <code>_</code> contre seulement ±220ms pour les 700 restant. Cela peut se comprendre assez facilement, plus il y a de types dans la template, plus la création d&rsquo;un identifiant au sein du compilateur va prendre du temps.</p>

<p>Le test 5 met clairement à défaut la version avec indice, car la mémoïsation ne s&rsquo;applique pas ici. Avec la version ternaire et récursive, lorsque le compilateur calcule la position d&rsquo;une liste de la forme <code>[0,1,2,3]</code>, il l&rsquo;a aussi fait pour <code>[1,2,3]</code>, <code>[2,3]</code> et <code>[3]</code> ce qui permet d&rsquo;être très rapide lorsqu&rsquo;il tombe sur des valeurs déjà évaluées. Or, la version avec indice ajoute un élément qui empêche cela: <code>&lt;0, [0,1,2,3]&gt;</code> se déroule en <code>&lt;1, [1,2,3]&gt;</code>, <code>&lt;2, [2,3]&gt;</code> et <code>&lt;3, [3]&gt;</code> alors que <code>&lt;0, [0,1,2]&gt;</code> se déroule en <code>&lt;1, [1,2]&gt;</code> et <code>&lt;2, [2]&gt;</code>. Les suites sont différentes, le compilateur crée donc beaucoup plus de types intermédiaires ce qui ralentit la compilation.</p>

<p>Dans l&rsquo;ensemble, l&rsquo;algorithme avec index est à éviter, car il montre qu&rsquo;une mauvaise mémoïsation ralentit fortement l&rsquo;évaluation de template. Il faut également éviter la version ternaire au profil d&rsquo;une implémentation qui stoppe la récursivité pour ne pas faire de calcul inutile. Finalement, l&rsquo;algorithme de récursion classique est plus rapide dans tous les cas.</p>

<p>Ce qui est vrai pour Gcc, ne l&rsquo;est pas forcément pour Clang comme le montre le graphique ci-dessous.</p>

<!-- ./gen_graphs.py compiler=g++ algo=recursive,recursive_indexed,recursive_ternary legend='~[];~all;~[_*1200];~[_*600, x*600];~n*' -- rec_clang -->

<p><img src="/post/mp_index_of/rec_clang_time.png" alt="duré de compilation avec clang de 3 implémentations récursives" /></p>

<p>Premier constat, le test 3 n&rsquo;a pas de pic inexplicable pour l&rsquo;algorithme avec indice. Et, bien que la version récursive classique soit toujours plus rapide que celle avec ternaire, il est amusant de constater que l&rsquo;implémentation avec indice supplante de peu la version classique. Sauf bien sûr lorsque la mémoïsation est mise à défaut comme dans le test 5.</p>

<p>Si on compare le temps de compilation entre Clang et Gcc, il s&rsquo;avère que Gcc est un peu plus rapide que son concurrent alors même que les premiers tests se font sur une liste de 1200 éléments contre 1400. De mon expérience, c&rsquo;est presque toujours le cas avec des templates récursives sur de &laquo;&nbsp;grands&nbsp;&raquo; ensembles.</p>

<div class="InfoBox"><p><strong class="InfoBox-title">Info :</strong> La limite de 1200 est dûe à une limitation de Clang qui ne peut pas dépasser 1293 niveaux de profondeur sans crasher (en tout cas chez moi probablement à cause d&rsquo;un dépassement de pile).</p></div>


<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#profiter-davantage-de-mémoïsation"><h2 id="profiter-davantage-de-mémoïsation">Profiter davantage de mémoïsation</h2></a>

<p>Il est possible d&rsquo;augmenter la mémoïsation en réduisant les types dans la liste en une suite de valeur <code>true</code>/<code>false</code>. La mémoïsation est alors beaucoup plus efficace, mais la comparaison se fait sur chaque élément de la liste. Heureusement, dans un code normal, la probabilité de tomber sur la même instance de <code>std::is_same&lt;T, U&gt;</code> est très grande ce qui rend cette solution encore plus efficace.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive_bool</span>
<span class="p">{</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">recursive</span><span class="o">::</span><span class="n">mp_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="p">,</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>L&rsquo;utilisation de <code>typename std::is_same&lt;T, Ts&gt;::type</code> au lieu de simplement <code>std::is_same&lt;T, Ts&gt;</code> permet de restreindre les types à <code>std::false_type</code> et <code>std::true_type</code>.</p>

<p>On peut aussi faire la comparaison avec un <code>detail::_index_of</code> spécialement dédié à la recherche d&rsquo;un <code>std::true_type</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive_bool2</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">, </span><span class="nc">class</span><span class="p">...</span> <span class="n">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span>
  <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...,</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...,</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Et une autre version qui travaille sur des valeurs plutôt que des types pour vérifier si cela a une influence.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">recursive_bool3</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">bool</span><span class="p">...</span> <span class="n">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span>
  <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span> <span class="n">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">true</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">...,</span> <span class="nb">true</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">...,</span> <span class="nb">true</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<!-- ./gen_graphs.py compiler=g++ algo=recursive,recursive_bool\? legend='~[];~all;~[_*1400];~[_*700, x*700];~n*' -- rec_bool_gcc -->

<p><img src="/post/mp_index_of/rec_bool_gcc_time.png" alt="comparaison de temps de 3 implémentations qui font une transformation en booléan" /></p>

<p>Là où la version récursive était rapide, la transformation en une liste de booléan l&rsquo;est tout autant. Le bénéfice devient évident sur une grande variété de listes (test 4) et des listes homogènes (test 6) où le temps de compilation est réduit par 3.</p>

<p>L&rsquo;algorithme <code>recursive_bool2</code> spécialisé dans la recherche d&rsquo;un <code>std::true_type</code> permet de grappiller encore quelques millisecondes principalement grâce à une spécialisation de template en moins.</p>

<p>À contrario, la version 3 qui manipule des booléens plutôt que des types est lente. Manipuler des types serait donc plus rapide que manipuler des valeurs dans les spécialisations. Le même comportement est présent dans Clang, même s&rsquo;il est moins prononcé.</p>

<!-- ./gen_graphs.py compiler=clang++ algo=recursive,recursive_bool\? legend='~[];~all;~[_*1200];~[_*600, x*600];~n*' -- rec_bool_clang -->

<p><img src="/post/mp_index_of/rec_bool_clang_time.png" alt="comparaison de temps de 3 implémentations qui font une transformation en booléan" /></p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#récursivité-par-bloc"><h2 id="récursivité-par-bloc">Récursivité par bloc</h2></a>

<p>La récursivité possède un défaut qui n&rsquo;est pas forcément un problème dans le code de tous les jours: le niveau de récursion est limité par le compilateur. Gcc s&rsquo;arrête à une profondeur de 900, Clang à 1024 et si je ne me trompe pas, la limite est de 500 pour MSVC. Bien sûr, cela est configurable. C&rsquo;est d&rsquo;ailleurs ce qui a été fait pour générer les premiers graphiques même si comme dit précédemment, Clang crashe lorsqu&rsquo;on dépasse 1293.</p>

<p>Une technique employée pour dépasser artificiellement cette limite est de prendre plusieurs valeurs par niveau de récursivité. Cela réduit la profondeur de récursion et le nombre de types instanciés. S&rsquo;il y a moins de types instanciés, la compilation devrait également être plus rapide.</p>

<p>Le code devient malheureusement beaucoup plus verbeux et compliqué:</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">pack8</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> </span><span class="nc">U0</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U1</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U2</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U3</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U4</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U5</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U6</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U7</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span>
  <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U0</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U1</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U2</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U3</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U4</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U5</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U6</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span>
                                 <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U7</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">8</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U0</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U1</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U2</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U3</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U4</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U5</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U6</span><span class="o">&gt;</span> <span class="o">||</span>
                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U7</span><span class="o">&gt;</span>
    <span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U0</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U1</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U2</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U3</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U4</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U5</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U6</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U7</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">true</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">U0</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">U3</span><span class="p">,</span> <span class="n">U4</span><span class="p">,</span> <span class="n">U5</span><span class="p">,</span> <span class="n">U6</span><span class="p">,</span> <span class="n">U7</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U0</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U1</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U2</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U3</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U4</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U5</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U6</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U7</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">U0</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">U3</span><span class="p">,</span> <span class="n">U4</span><span class="p">,</span> <span class="n">U5</span><span class="p">,</span> <span class="n">U6</span><span class="p">,</span> <span class="n">U7</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U0</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U1</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U2</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U3</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U4</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U5</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U6</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U7</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">8</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Et L&rsquo;équivalent qui fait une transformation en liste de booléen avant:</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">pack8_bool</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="n">Ok</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> </span><span class="nc">U0</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U1</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U2</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U3</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U4</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U5</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U6</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U7</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">_index_of</span>
  <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="p">(</span><span class="n">U0</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
                                 <span class="n">U1</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
                                 <span class="n">U2</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span>
                                 <span class="n">U3</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span>
                                 <span class="n">U4</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span>
                                 <span class="n">U5</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span>
                                 <span class="n">U6</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span>
                                 <span class="n">U7</span><span class="o">::</span><span class="n">value</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="mi">8</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="n">U0</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U1</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U2</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U3</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U4</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U5</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U6</span><span class="o">::</span><span class="n">value</span> <span class="o">||</span>
                <span class="n">U7</span><span class="o">::</span><span class="n">value</span>
    <span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">U0</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U1</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U2</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U3</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U4</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U5</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U6</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U7</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Rest</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">true</span><span class="p">,</span> <span class="n">U0</span><span class="p">,</span> <span class="n">U1</span><span class="p">,</span> <span class="n">U2</span><span class="p">,</span> <span class="n">U3</span><span class="p">,</span> <span class="n">U4</span><span class="p">,</span> <span class="n">U5</span><span class="p">,</span> <span class="n">U6</span><span class="p">,</span> <span class="n">U7</span><span class="p">,</span> <span class="n">Rest</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
  <span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">))</span>
    <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<!-- ./gen_graphs.py compiler=g++ algo=recursive_bool2,pack8,pack8_bool legend='~[];~all;~[_*1400];~[_*700, x*700];~n*' -- pack8_gcc -->

<p><img src="/post/mp_index_of/pack8_gcc_time.png" alt="duré de compilation avec gcc pour un algo récursive par pack de 8" /></p>

<p>Même lorsque la position de <code>x</code> est éloignée (test 2 et 3), les <code>pack8</code> sont efficaces. Si on prend la différence entre le test 1 et 2, et 2 et 3, il y a plus ou moins un facteur 8.</p>

<p>Comme c&rsquo;était le cas lorsqu&rsquo;on comparaît l&rsquo;algorithme <code>recursive</code> avec <code>recursive_bool</code>, <code>pack8_bool</code> est plus rapide que <code>pack8</code> lorsque le nombre de listes différentes augmente (test 5 et 7).</p>

<p>Le test 6 profite déjà d&rsquo;une mémoïsation optimale pour les 3 implémentations, même si <code>pack8_bool</code> est un chouia plus lent que les autres ici.</p>

<p>Toutefois, la suprématie de <code>pack8_bool</code> par rapport à <code>pack8</code> est beaucoup plus ténue avec Clang.</p>

<!-- ./gen_graphs.py compiler=clang++ algo=recursive_bool2,pack8,pack8_bool legend='~[];~all;~[_*1200];~[_*600, x*600];~n*' -- pack8_clang -->

<p><img src="/post/mp_index_of/pack8_clang_time.png" alt="duré de compilation avec gcc pour un algo récursive par pack de 8" /></p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#penser-différemment"><h2 id="penser-différemment">Penser différemment</h2></a>

<p>Plutôt qu&rsquo;avoir un <code>index_of</code> le plus rapide possible, il est possible de combiner d&rsquo;autres algorithmes pour arriver au même résultat. Il y a un double avantage dans le cadre d&rsquo;une bibliothèque de méta-programmation:</p>

<ul>
<li>Implémenter un nouvel algorithme efficace est plus facile, car les optimisations telles que celles utilisées par <code>pack8</code> sont déportées sur ceux avec une réelle implémentation.</li>
<li>Un nombre restreint d&rsquo;algorithmes est plus souvent utilisé ce qui augmente la mémoïsation.</li>
</ul>

<p>Ainsi, <code>index_of</code> peut se faire en combinant <code>std::make_index_sequence</code>, <code>join</code>, <code>front</code> et éventuellement <code>tranform</code>. On peut aussi le faire avec <code>foldl</code>/<code>foldr</code>.</p>

<p>Pour le faire avec <code>join</code>, on construit une liste d&rsquo;indices de la taille de <code>Ts</code> qui est ensuite transformée en <code>list&lt;i&gt;</code> lorsque le type est identique à <code>T</code> et en <code>list&lt;&gt;</code> dans le cas contraire. Puis, on fusionne toutes les listes en une seule avec un <code>int&lt;-1&gt;</code> ajouté en fin. Le premier élément de cette liste correspond au résultat de <code>index_of</code>.</p>

<p>Il serait préférable de ne pas ajouter <code>-1</code>, mais ajouter une valeur dans la liste puis faire un post traitement. Cela augmente les collisions de type et par conséquent la mémoïsation. Mais restons simple !</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">by_indices</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">...</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">list</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">L</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">front</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">front</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&gt;</span>
  <span class="p">{</span>
    <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span> <span class="k">class</span><span class="err"> = </span><span class="nc">list</span><span class="o">&lt;&gt;</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">Ls</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_join</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">_0</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_1</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_2</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_3</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_4</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_5</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_6</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_7</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_8</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_9</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_10</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_11</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_12</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_13</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_14</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_15</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_16</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_17</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_18</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_19</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_20</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_21</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_22</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_23</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_24</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_25</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_26</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_27</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_28</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_29</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_30</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_31</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_32</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_33</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_34</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_35</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_36</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_37</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_38</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_39</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_40</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_41</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_42</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_43</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_44</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_45</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_46</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_47</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_48</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_49</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_50</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_51</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_52</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_53</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_54</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_55</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_56</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_57</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_58</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_59</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_60</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_61</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_62</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_63</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_join</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">_0</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_2</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_3</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_4</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_5</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_6</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_7</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_8</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_9</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_10</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_11</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_12</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_13</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_14</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_15</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_16</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_17</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_18</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_19</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_20</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_21</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_22</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_23</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_24</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_25</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_26</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_27</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_28</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_29</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_30</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_31</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_32</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_33</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_34</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_35</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_36</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_37</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_38</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_39</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_40</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_41</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_42</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_43</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_44</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_45</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_46</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_47</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_48</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_49</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_50</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_51</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_52</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_53</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_54</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_55</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_56</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_57</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_58</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_59</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_60</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_61</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_62</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_63</span><span class="p">...</span><span class="o">&gt;&gt;</span>
  <span class="p">{</span>
    <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_0</span><span class="p">...,</span> <span class="n">_1</span><span class="p">...,</span> <span class="n">_2</span><span class="p">...,</span> <span class="n">_3</span><span class="p">...,</span> <span class="n">_4</span><span class="p">...,</span> <span class="n">_5</span><span class="p">...,</span> <span class="n">_6</span><span class="p">...,</span> <span class="n">_7</span><span class="p">...,</span>
                      <span class="n">_8</span><span class="p">...,</span> <span class="n">_9</span><span class="p">...,</span> <span class="n">_10</span><span class="p">...,</span> <span class="n">_11</span><span class="p">...,</span> <span class="n">_12</span><span class="p">...,</span> <span class="n">_13</span><span class="p">...,</span> <span class="n">_14</span><span class="p">...,</span> <span class="n">_15</span><span class="p">...,</span>
                      <span class="n">_16</span><span class="p">...,</span> <span class="n">_17</span><span class="p">...,</span> <span class="n">_18</span><span class="p">...,</span> <span class="n">_19</span><span class="p">...,</span> <span class="n">_20</span><span class="p">...,</span> <span class="n">_21</span><span class="p">...,</span> <span class="n">_22</span><span class="p">...,</span> <span class="n">_23</span><span class="p">...,</span>
                      <span class="n">_24</span><span class="p">...,</span> <span class="n">_25</span><span class="p">...,</span> <span class="n">_26</span><span class="p">...,</span> <span class="n">_27</span><span class="p">...,</span> <span class="n">_28</span><span class="p">...,</span> <span class="n">_29</span><span class="p">...,</span> <span class="n">_30</span><span class="p">...,</span> <span class="n">_31</span><span class="p">...,</span>
                      <span class="n">_32</span><span class="p">...,</span> <span class="n">_33</span><span class="p">...,</span> <span class="n">_34</span><span class="p">...,</span> <span class="n">_35</span><span class="p">...,</span> <span class="n">_36</span><span class="p">...,</span> <span class="n">_37</span><span class="p">...,</span> <span class="n">_38</span><span class="p">...,</span> <span class="n">_39</span><span class="p">...,</span>
                      <span class="n">_40</span><span class="p">...,</span> <span class="n">_41</span><span class="p">...,</span> <span class="n">_42</span><span class="p">...,</span> <span class="n">_43</span><span class="p">...,</span> <span class="n">_44</span><span class="p">...,</span> <span class="n">_45</span><span class="p">...,</span> <span class="n">_46</span><span class="p">...,</span> <span class="n">_47</span><span class="p">...,</span>
                      <span class="n">_48</span><span class="p">...,</span> <span class="n">_49</span><span class="p">...,</span> <span class="n">_50</span><span class="p">...,</span> <span class="n">_51</span><span class="p">...,</span> <span class="n">_52</span><span class="p">...,</span> <span class="n">_53</span><span class="p">...,</span> <span class="n">_54</span><span class="p">...,</span> <span class="n">_55</span><span class="p">...,</span>
                      <span class="n">_56</span><span class="p">...,</span> <span class="n">_57</span><span class="p">...,</span> <span class="n">_58</span><span class="p">...,</span> <span class="n">_59</span><span class="p">...,</span> <span class="n">_60</span><span class="p">...,</span> <span class="n">_61</span><span class="p">...,</span> <span class="n">_62</span><span class="p">...,</span> <span class="n">_63</span><span class="p">...</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">_0</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_1</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_2</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_3</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_4</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_5</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_6</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_7</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_8</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_9</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_10</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_11</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_12</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_13</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_14</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_15</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_16</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_17</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_18</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_19</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_20</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_21</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_22</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_23</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_24</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_25</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_26</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_27</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_28</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_29</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_30</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_31</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_32</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_33</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_34</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_35</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_36</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_37</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_38</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_39</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_40</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_41</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_42</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_43</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_44</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_45</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_46</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_47</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_48</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_49</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_50</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_51</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_52</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_53</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_54</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_55</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">_56</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_57</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_58</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_59</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_60</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_61</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_62</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">_63</span><span class="p">,</span>
           <span class="k">class</span><span class="err">... </span><span class="nc">Ls</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_join</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">_0</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_2</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_3</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_4</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_5</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_6</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_7</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_8</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_9</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_10</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_11</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_12</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_13</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_14</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_15</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_16</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_17</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_18</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_19</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_20</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_21</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_22</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_23</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_24</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_25</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_26</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_27</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_28</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_29</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_30</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_31</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_32</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_33</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_34</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_35</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_36</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_37</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_38</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_39</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_40</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_41</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_42</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_43</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_44</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_45</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_46</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_47</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_48</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_49</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_50</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_51</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_52</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_53</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_54</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_55</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">list</span><span class="o">&lt;</span><span class="n">_56</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_57</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_58</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_59</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_60</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_61</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_62</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">_63</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span>
               <span class="n">Ls</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">_join</span><span class="o">&lt;</span><span class="n">list</span><span class="o">&lt;</span><span class="n">_0</span><span class="p">...,</span> <span class="n">_1</span><span class="p">...,</span> <span class="n">_2</span><span class="p">...,</span> <span class="n">_3</span><span class="p">...,</span> <span class="n">_4</span><span class="p">...,</span> <span class="n">_5</span><span class="p">...,</span> <span class="n">_6</span><span class="p">...,</span> <span class="n">_7</span><span class="p">...,</span>
               <span class="n">_8</span><span class="p">...,</span> <span class="n">_9</span><span class="p">...,</span> <span class="n">_10</span><span class="p">...,</span> <span class="n">_11</span><span class="p">...,</span> <span class="n">_12</span><span class="p">...,</span> <span class="n">_13</span><span class="p">...,</span> <span class="n">_14</span><span class="p">...,</span> <span class="n">_15</span><span class="p">...,</span>
               <span class="n">_16</span><span class="p">...,</span> <span class="n">_17</span><span class="p">...,</span> <span class="n">_18</span><span class="p">...,</span> <span class="n">_19</span><span class="p">...,</span> <span class="n">_20</span><span class="p">...,</span> <span class="n">_21</span><span class="p">...,</span> <span class="n">_22</span><span class="p">...,</span> <span class="n">_23</span><span class="p">...,</span>
               <span class="n">_24</span><span class="p">...,</span> <span class="n">_25</span><span class="p">...,</span> <span class="n">_26</span><span class="p">...,</span> <span class="n">_27</span><span class="p">...,</span> <span class="n">_28</span><span class="p">...,</span> <span class="n">_29</span><span class="p">...,</span> <span class="n">_30</span><span class="p">...,</span> <span class="n">_31</span><span class="p">...,</span>
               <span class="n">_32</span><span class="p">...,</span> <span class="n">_33</span><span class="p">...,</span> <span class="n">_34</span><span class="p">...,</span> <span class="n">_35</span><span class="p">...,</span> <span class="n">_36</span><span class="p">...,</span> <span class="n">_37</span><span class="p">...,</span> <span class="n">_38</span><span class="p">...,</span> <span class="n">_39</span><span class="p">...,</span>
               <span class="n">_40</span><span class="p">...,</span> <span class="n">_41</span><span class="p">...,</span> <span class="n">_42</span><span class="p">...,</span> <span class="n">_43</span><span class="p">...,</span> <span class="n">_44</span><span class="p">...,</span> <span class="n">_45</span><span class="p">...,</span> <span class="n">_46</span><span class="p">...,</span> <span class="n">_47</span><span class="p">...,</span>
               <span class="n">_48</span><span class="p">...,</span> <span class="n">_49</span><span class="p">...,</span> <span class="n">_50</span><span class="p">...,</span> <span class="n">_51</span><span class="p">...,</span> <span class="n">_52</span><span class="p">...,</span> <span class="n">_53</span><span class="p">...,</span> <span class="n">_54</span><span class="p">...,</span> <span class="n">_55</span><span class="p">...,</span>
               <span class="n">_56</span><span class="p">...,</span> <span class="n">_57</span><span class="p">...,</span> <span class="n">_58</span><span class="p">...,</span> <span class="n">_59</span><span class="p">...,</span> <span class="n">_60</span><span class="p">...,</span> <span class="n">_61</span><span class="p">...,</span> <span class="n">_62</span><span class="p">...,</span> <span class="n">_63</span><span class="p">...</span>
          <span class="o">&gt;</span><span class="p">,</span> <span class="n">Ls</span><span class="p">...</span><span class="o">&gt;</span> <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">Ints</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_find_index</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">if_</span>
  <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
    <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">U</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;&gt;</span>
  <span class="k">struct</span> <span class="n">if_</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="o">&gt;</span>
  <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
    <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">...</span> <span class="n">Ints</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Is</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">_find_index</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">integer_sequence</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">,</span> <span class="n">Ints</span><span class="p">...</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Is</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">front</span><span class="o">&lt;</span>
      <span class="k">typename</span> <span class="n">_join</span><span class="o">&lt;</span>
        <span class="k">typename</span> <span class="n">if_</span><span class="o">&lt;</span><span class="n">Is</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">type</span><span class="o">&lt;</span>
          <span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">(</span><span class="n">Ints</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">,</span>
          <span class="n">list</span><span class="o">&lt;&gt;</span>
        <span class="o">&gt;</span><span class="p">...,</span>
        <span class="n">list</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">&gt;&gt;</span>
      <span class="o">&gt;::</span><span class="n">type</span>
    <span class="o">&gt;</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">_find_index</span><span class="o">&lt;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">make_index_sequence</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Wooa, cette monstruosité. Il faut être complètement barge pour écrire cette horreur. C&rsquo;est pourtant une chose que l&rsquo;on trouve dans <a href="https://github.com/brunocodutra/metal/blob/master/include/metal/list/join.hpp#L51">Metal</a>, <a href="https://github.com/edouarda/brigand/blob/master/include/brigand/sequences/append.hpp#L29">Brigand</a>, <a href="https://github.com/boostorg/mp11/blob/develop/include/boost/mp11/detail/mp_append.hpp#L48">Cpp11</a> ou <a href="https://github.com/boostorg/hana/blob/master/include/boost/hana/detail/variadic/foldl1.hpp#L23">Boost.Hana</a>. La palme d&rsquo;or revient à <a href="https://github.com/kvasir-io/mpl/blob/development/src/kvasir/mpl/sequence/join.hpp#L14">Kvasir.Mpl</a> avec une template de 1025 éléments variadiques.</p>

<!-- ./gen_graphs.py compiler=g++ algo=recursive,pack8_bool,by_indices legend='~[];~all;~[_*1400];~[_*700, x*700]' -- by_indices -->

<p><img src="/post/mp_index_of/by_indices_time.png" alt="comparaison de temps avec gcc de pack8 et une qui utilise d'autres algorithmes" /></p>

<p>C&rsquo;est étonnamment efficace. Pas autant que <code>pack8_bool</code>, mais globalement plus qu&rsquo;une récursion classique. Dans un projet, <code>join</code> et <code>front</code> seront utilisés ailleurs et à travers d&rsquo;autres algorithmes ce qui, toujours grâce à la mémoïsation, réduit le coût total.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#fonction-constexpr"><h2 id="fonction-constexpr">Fonction constexpr</h2></a>

<p>Depuis C++14, il est possible d&rsquo;avoir des conditions et des boucles dans les fonctions. On peut alors écrire <code>index_of</code> presque comme on écrirait n&rsquo;importe quelle fonction impérative.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">loop</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span> <span class="n">xs</span><span class="o">&gt;</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">_index_of</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">matches</span><span class="p">[]{</span><span class="n">xs</span><span class="p">...,</span> <span class="nb">false</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">xs</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
    <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Les booléens sont en paramètre template. C&rsquo;est dommage, parce que cela limite les transferts de paramètre depuis une autre fonction. Il vaut mieux mettre les valeurs en paramètre de fonction comme on le fait d&rsquo;habitude.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">loop2</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">_index_of</span><span class="p">(</span><span class="n">T</span><span class="p">...</span> <span class="n">xs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">matches</span><span class="p">[]{</span><span class="n">xs</span><span class="p">...,</span> <span class="nb">false</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">xs</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span>
    <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;</span><span class="p">...)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>C&rsquo;est beau, c&rsquo;est simple, c&rsquo;est élégant.</p>

<!-- ./gen_graphs.py compiler=g++ algo=pack8_bool,loop\? legend='~[];~all;~[_*1400];~[_*700, x*700];~n*' -- func -->

<p><img src="/post/mp_index_of/func_time.png" alt="comparaison de temps de pack8_bool et une fonction constexpr" /></p>

<p>C&rsquo;est fou, mais dans l&rsquo;ensemble on y gagne encore. Néanmoins, la version qui prend les valeurs en paramètre est légèrement plus lente.</p>

<p>J&rsquo;ai aussi essayé avec des fonctions récursives, mais c&rsquo;est une vraie catastrophe. Premièrement, c&rsquo;est extrêmement lent. Deuxièmement, la profondeur de récursion est encore plus basse qu&rsquo;avec les templates: 512 pour Gcc (900 avec templates) et 800 pour Clang (1024 avec template). Mais surtout, une profondeur trop grande fait rapidement planter Clang.</p>

<p>En réalité, le coût d&rsquo;appel de fonction est supérieur à celui d&rsquo;une instanciation de classe. Mais si la fonction n&rsquo;est pas récursive, alors le coût peut être amorti par rapport à une implémentation récursive, comme ici.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#fold-expression"><h2 id="fold-expression">Fold expression</h2></a>

<p>En C++17 arrive les fold expressions. Plus besoin de boucle explicite ou de fonction récursive pour dérouler des valeurs. Seulement, avec <code>index_of</code>, il faut jouer d&rsquo;ingéniosité pour stopper le fold tout en ayant un compteur qui s&rsquo;incrémente. La manière la plus simple est de mettre plusieurs instructions séparées par des <code>,</code>. La dernière valeur de cette &laquo;&nbsp;liste&nbsp;&raquo; sera celle utilisée pour vérifier si <code>T</code> égale <code>Ts</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">fold</span>
<span class="p">{</span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span> <span class="n">xs</span><span class="o">&gt;</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">_index_of</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)((((</span><span class="kt">void</span><span class="p">)</span><span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">!</span><span class="n">xs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">...)</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="kt">int</span><span class="p">(</span><span class="k">sizeof</span><span class="p">...(</span><span class="n">xs</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">i</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">detail</span><span class="o">::</span><span class="n">_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_same_v</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Le code est beaucoup plus concis, mais aussi beaucoup plus obscur. Il faut dire que <code>index_of</code> n&rsquo;est pas le meilleur algorithme pour représenter la beauté des folds ;).</p>

<!-- ./gen_graphs.py compiler=g++ algo=loop2,fold legend='~[];~all;~[_*1400];~[_*700, x*700]' -- fold_gcc -->

<p><img src="/post/mp_index_of/fold_gcc_time.png" alt="comparaison de temps avec gcc d'une fonction constexpr et un fold" /></p>

<p>Le résultat est très similaire à une boucle manuelle. Clang donne la même chose, mais les versions précédentes de Gcc sont extrêmement lentes avec les fold.</p>

<!-- ./gen_graphs.py compiler=g++-7 algo=loop2,fold legend='~[];~all;~[_*1400];~[_*700, x*700]' -- fold_clang -->

<p><img src="/post/mp_index_of/fold_clang_time.png" alt="comparaison de temps avec clang d'une fonction constexpr et un fold" /></p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/#pour-terminer"><h2 id="pour-terminer">Pour terminer</h2></a>

<p>On peut retenir de ces différents tests que</p>

<ul>
<li>le nombre de spécialisations a un coût,</li>
<li>le temps de compilation est quadratique au nombre de paramètre variadique,</li>
<li>il faut limiter la récursion et le nombre de types instanciés,</li>
<li>les algorithmes doivent profiter de la mémoïsation,</li>
<li>spécialiser des valeurs est plus lent que spécialiser des types,</li>
<li>les fold expressions sont très efficaces,</li>
<li>une fonction constexpr est lente à instancier, mais l&rsquo;utilisation de boucle peut compenser ce défaut.</li>
</ul>

<p>Il n&rsquo;y a pas eu de test sur l&rsquo;affirmation qui va suivre, mais d&rsquo;expérience, je sais que les alias sont plus rapides qu&rsquo;une instanciation de classe, mais aussi plus cryptique au niveau des erreurs.</p>

<p>Si vous voulez des graphiques qui comparent 2 compilateurs, le générateur de graphe et les résultats de compilation se trouvent dans <a href="https://github.com/jonathanpoelen/jonathanpoelen.github.io/tree/source/resources/mp_index_of">le dépôt</a>
.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-10-01T18:28:21">01 octobre 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/10/comparaison-de-differentes-implementations-de-mp_index_of/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="acfe95c97195256c7843e5c852ec2097-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f&amp;title=comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f10%2fcomparaison-de-differentes-implementations-de-mp_index_of%2f&amp;name=comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="au-c%C5%93ur-dun-variant"><span>
        <a href="#comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Comparaison de différentes implémentations de mp_index_of"></i></a>
        <a href="#faites-parler-votre-compilateur"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Faites parler votre compilateur"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/">Au cœur d&#39;un variant</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#comparaison-de-diff%25C3%25A9rentes-impl%25C3%25A9mentations-de-mp_index_of">Article suivant: Comparaison de différentes implémentations de mp_index_of</a><br/>
        <a href="#faites-parler-votre-compilateur">Article précédent: Faites parler votre compilateur</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-09-02T14:45:55">02 septembre 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>9 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#dc9b2e982ad7fe0bb2aca98f8a852275-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Cet article va être consacré à la réalisation d&rsquo;une classe variant comme on peut la trouver dans la <a href="http://en.cppreference.com/w/cpp/utility/variant">stl</a>, <a href="http://en.cppreference.com/w/cpp/utility/variant">boost</a> et <a href="https://github.com/mapbox/variant">autres</a>. Il existe de nombreuses techniques plus ou moins simples à réaliser et plus ou moins coûteuses à l&rsquo;exécution. Je vais faire un petit tour de ce que j&rsquo;ai pu voir et comment les implémenter.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#rappel-sur-ce-qu-est-un-variant"><h2 id="rappel-sur-ce-qu-est-un-variant">Rappel sur ce qu&rsquo;est un variant</h2></a>

<p>Un variant est une <strong>union sécurisée</strong> comme on peut le trouver dans les langages fonctionnels.
Contrairement aux <a href="http://en.cppreference.com/w/cpp/language/union">union</a> classique du C++, le variant garde l&rsquo;information du type manipulé.
C&rsquo;est en cela qu&rsquo;il est sécurisé, on ne sélectionne pas une valeur d&rsquo;un certain type,
mais on fournit une fonction que le variant appelle avec le type enregistré.</p>

<p>Même si le variant peut aisément remplacer l&rsquo;héritage lorsque le nombre de classe dérivée est connue,
il est beaucoup plus adapté lorsque les valeurs priment sur les comportements.
Par exemple, une valeur d&rsquo;une structure JSON représente un nombre, un tableau, une chaîne de caractères ou un objet.
Il n&rsquo;y a pas de comportement commun, les traitements se feront en fonction du type de la valeur.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#un-premier-variant"><h2 id="un-premier-variant">Un premier variant</h2></a>

<p>Notre version minimale de variant va contenir:</p>

<ul>
<li>Les constructeurs par défaut, de copie et de déplacement.</li>
<li>Un constructeur pour initialiser avec un type de la liste.</li>
<li>Les opérateurs d&rsquo;affectation correspondant aux constructeurs.</li>
<li>Une fonction <code>visit</code> (en membre, pour des raisons de simplification).</li>
</ul>

<div class="InfoBox"><p><strong class="InfoBox-title">Info :</strong> <p>L&rsquo;implémentation qui va suivre se veut simple et surtout naïve. De ce fait, elle est totalement inefficace et montre l&rsquo;exemple à ne pas suivre.
  Elle servira néanmoins de base de travail et sera peaufinée tout au long des chapitres pour atteindre l&rsquo;<em>idéal</em> du variant.</p>
</p></div>


<p>Comme le type change en cours de route, nous allons utiliser en interne une classe de base qui pour chaque dérivée va contenir le type réel.
Grâce à cela, le type stocké pourra être supprimé et un nouveau type pourra y être enregistré.
Cette classe de base pourra aussi servir à implémenter l&rsquo;opérateur de copie via une fonction <code>clone</code>.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">VariantBase</span>
  <span class="p">{</span>
    <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VariantBase</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">VariantBase</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">class</span><span class="err"> </span><span class="nc">Variant</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">Variant</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">Variant</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">);</span>

  <span class="n">Variant</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Variant</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">Variant</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">Variant</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">);</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">visit</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">VariantBase</span><span class="o">&gt;</span> <span class="n">impl_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Pour ne pas parasiter les codes, je n&rsquo;ajoute pas les noexcept. De toute façon, avec les allocations dynamiques, cela ne va pas être évident.</p>

<p>Toute la difficulté va se trouver dans les implémentations de <code>VariantBase</code> et la fonction <code>visit</code>. Pour en faire une dérivée, un pattern assez commun va être utilisé, celui d&rsquo;avoir une classe <code>VariantImpl</code> template sur le type à stocker.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="nl">VariantImpl</span> <span class="p">:</span> <span class="n">VariantBase</span>
  <span class="p">{</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
    <span class="n">VariantImpl</span><span class="p">(</span><span class="n">U</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">value_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">{}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">VariantBase</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">()</span> <span class="k">override</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VariantImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">T</span> <span class="n">value_</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">make_variant_impl</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">VariantImpl</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span>
      <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="o">:</span> <span class="n">impl_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">impl_</span><span class="o">-&gt;</span><span class="n">clone</span><span class="p">())</span>
<span class="p">{}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">Variant</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="o">:</span> <span class="n">impl_</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">make_variant_impl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="p">{}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&amp;</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">impl_</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">impl_</span> <span class="o">?</span> <span class="n">other</span><span class="p">.</span><span class="n">impl_</span><span class="o">-&gt;</span><span class="n">clone</span><span class="p">()</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&amp;</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">impl_</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">make_variant_impl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>En réalité ce qu&rsquo;on vient de faire ici n&rsquo;est ni plus ni moins qu&rsquo;un <code>std::any</code>. Si on réfléchit bien, nous ne sommes pas limités dans les types à stocker et il n&rsquo;y a aucune vérification au niveau de l&rsquo;initialisation d&rsquo;une valeur. C&rsquo;est mal, mais on va rester comme cela pour le moment.</p>

<p>Reste ensuite la fonction <code>visit</code>. À ce stade, je dirais que la solution la plus naturelle est d&rsquo;utiliser <code>dynamic_cast</code> pour déterminer le type réel et appeler la bonne surcharge de fonction.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="o">&gt;</span>
<span class="k">auto</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">visit</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">impl_</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">visit_impl</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">rec</span><span class="p">,</span> <span class="k">auto</span><span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="k">auto</span><span class="o">*</span><span class="p">...</span> <span class="n">ts</span><span class="p">){</span>
    <span class="k">using</span> <span class="n">Impl</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">VariantImpl</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">;</span>
    <span class="k">if</span> <span class="nf">constexpr</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">...(</span><span class="n">ts</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">impl_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
        <span class="o">?</span> <span class="n">f</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">impl_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">value_</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">rec</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">ts</span><span class="p">...);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">rec</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">f</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">impl_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">value_</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nf">visit_impl</span><span class="p">(</span><span class="n">visit_impl</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Ts</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)...);</span>
<span class="p">}</span>
</code></pre></div>


<p>Cette implémentation parcourt récursivement les types du variant pour trouver celui qui correspond à la valeur de <code>impl_</code>, appel <code>f</code> avec le bon type puis propage son retour en remontant la pile d&rsquo;appel.
Le dernier élément est un cas spécial traité dans le <code>else</code> car, quand on le compare avec <code>dynamic_cast</code>, le résultat est toujours vrai.
Comme notre variant ne contient &ndash;normalement&ndash; qu&rsquo;un nombre restreint de types, si la valeur de <code>impl_</code> ne correspond pas aux types qui précèdent le dernier, alors <code>impl_</code> est forcément du type du dernier élément.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#moi-j-aime-pas-dynamic-cast"><h2 id="moi-j-aime-pas-dynamic-cast">Moi j&rsquo;aime pas dynamic_cast</h2></a>

<p><code>dynamic_cast</code> est souvent un signe révélateur d&rsquo;un problème de conception. Si on abstrait les valeurs, c&rsquo;est dans le but de ne pas se soucier du type de l&rsquo;implémentation. Or, un variant met le focus sur le type et rend caduque cette abstraction. Seulement, <code>dynamic_cast</code> a un coût d&rsquo;exécution exorbitant par rapport à la tâche qu&rsquo;il effectue ici.</p>

<p>De ce fait, <code>dynamic_cast</code> n&rsquo;est pas une bonne solution, il est plus judicieux de conserver une information pour différencier les types. Comme un variant contient une liste d&rsquo;éléments, l&rsquo;indice du type utilisé suffit amplement.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span><span class="err"> </span><span class="nc">Variant</span>
<span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">detail</span><span class="o">::</span><span class="n">VariantBase</span><span class="o">&gt;</span> <span class="n">impl_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">type_index_</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Maintenant, il faut convertir un type en indice, c&rsquo;est à ce moment que la méta-programmation arrive à la rescousse.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;type_traits&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">count_items_to_right_of</span><span class="p">;</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Us</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">count_items_to_right_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">Us</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">count_items_to_right_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Us</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="p">{};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Us</span><span class="o">&gt;</span>
  <span class="k">struct</span> <span class="n">count_items_to_right_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Us</span><span class="p">...</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Us</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="p">{};</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">mp_index_of</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">,</span>
  <span class="k">sizeof</span><span class="p">...(</span><span class="n">Ts</span><span class="p">)</span> <span class="o">-</span> <span class="n">detail</span><span class="o">::</span><span class="n">count_items_to_right_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span>
<span class="o">&gt;</span><span class="p">;</span>
</code></pre></div>


<p><code>mp_index_of</code> est un alias sur <code>std::integral_constant</code>. L&rsquo;implémentation déroule récursivement les éléments de <code>Ts</code> jusqu&rsquo;à trouver <code>T</code> et retourne le nombre d&rsquo;éléments qu&rsquo;il reste dans la liste. Soustraire ce résultat à <code>sizeof...(Ts) - 1</code> permet d&rsquo;avoir la position de <code>T</code>.</p>

<p>On met à jour l&rsquo;implémentation pour initialiser le nouveau membre.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">Variant</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="o">:</span> <span class="n">impl_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">impl_</span><span class="o">-&gt;</span><span class="n">clone</span><span class="p">())</span>
<span class="p">,</span> <span class="n">type_index_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">type_index_</span><span class="p">)</span>
<span class="p">{}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">Variant</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="o">:</span> <span class="n">impl_</span><span class="p">(</span><span class="n">detail</span><span class="o">::</span><span class="n">make_variant_impl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="p">,</span> <span class="n">type_index_</span><span class="p">(</span><span class="n">mp_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span>
<span class="p">{}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&amp;</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Variant</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">impl_</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">impl_</span> <span class="o">?</span> <span class="n">other</span><span class="p">.</span><span class="n">impl_</span><span class="o">-&gt;</span><span class="n">clone</span><span class="p">()</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="n">type_index_</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">type_index_</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&amp;</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">impl_</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">make_variant_impl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
  <span class="n">type_index_</span> <span class="o">=</span> <span class="n">mp_index_of</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>Puis on supprime <code>dynamic_cast</code> de la fonction <code>visit</code>, le remplaçant par une comparaison d&rsquo;index.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">F</span><span class="o">&gt;</span>
<span class="k">auto</span> <span class="n">Variant</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">visit</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">impl_</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">visit_impl</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span> <span class="n">rec</span><span class="p">,</span> <span class="k">auto</span><span class="o">*</span> <span class="n">t</span><span class="p">,</span> <span class="k">auto</span><span class="o">*</span><span class="p">...</span> <span class="n">ts</span><span class="p">){</span>
    <span class="k">using</span> <span class="n">T</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">Impl</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">VariantImpl</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">;</span>
    <span class="k">if</span> <span class="nf">constexpr</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">...(</span><span class="n">ts</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">type_index_</span> <span class="o">==</span> <span class="n">mp_index_of</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;::</span><span class="n">value</span>
        <span class="o">?</span> <span class="n">f</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">impl_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">value_</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">rec</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">ts</span><span class="p">...);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">rec</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">f</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">impl_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">value_</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nf">visit_impl</span><span class="p">(</span><span class="n">visit_impl</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Ts</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)...);</span>
<span class="p">}</span>
</code></pre></div>


<p>Peu de changement finalement, mais maintenant <code>variant</code> peut fonctionner sans support de <a href="https://fr.wikipedia.org/wiki/Run-time_type_information">RTTI</a> !</p>

<p>On notera aussi que puisque nous possédons l&rsquo;indice lié au type, on peut aussi remplacer les fonctions virtuelles par un appel à <code>visit</code> pour supprimer la vtable et enlever l&rsquo;indirection pour accéder aux fonctions virtuelles dans celle-ci.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#l-allocation-dynamique-n-est-pas-gratuite"><h2 id="l-allocation-dynamique-n-est-pas-gratuite">L&rsquo;allocation dynamique n&rsquo;est pas gratuite</h2></a>

<p>Il est vrai que l&rsquo;allocation dynamique a un coût non négligeable sur les performances. Personne n&rsquo;a idée de faire <code>new int</code> alors qu&rsquo;en regardant de plus près, c&rsquo;est exactement ce que fait notre implémentation. Vient ensuite les déréférencements de pointeur qui font sauter des optimisations. Effet amplifié lorsque les fonctions sont <code>virtual</code>. Décidément, l&rsquo;allocation dynamique pour un variant n&rsquo;est pas une bonne idée.</p>

<p>Le mieux serait de stocker nos types de la même manière qu&rsquo;une union: un seul bloc mémoire de la taille du type le plus grand. À ma connaissance il existe 2 possibilités:</p>

<ul>
<li>une union récursive</li>
<li><a href="http://en.cppreference.com/w/cpp/types/aligned_union">std::aligned_union</a></li>
</ul>

<p>Pour choisir le procédé le plus efficace, nous implémentons les 2 dans une classe qui ne possède que les fonctions d&rsquo;accès et les constructeurs.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">AlignedStorage</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">aligned_union_t</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Sans les constructeurs, la version avec <code>std::aligned_union</code> est vraiment simple. Mais l&rsquo;utilisation de <code>reinterpret_cast</code> empêche de mettre la fonction <code>get()</code> en <code>constexpr</code> (gcc l&rsquo;accepte néanmoins).</p>

<p>À contrario, la version avec une union récursive est extrêmement verbeuse (toujours sans constructeur d&rsquo;initialisation de valeur):</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">namespace</span> <span class="n">detail</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="k">union</span> <span class="n">RecursiveUnion</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">RecursiveUnion</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span> <span class="n">others</span><span class="p">;</span>

    <span class="n">RecursiveUnion</span><span class="p">()</span> <span class="o">:</span> <span class="n">dummy</span><span class="p">()</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">RecursiveUnion</span><span class="p">(){}</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="k">union</span> <span class="n">RecursiveUnion</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">dummy</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">value</span><span class="p">;</span>

    <span class="n">RecursiveUnion</span><span class="p">()</span> <span class="o">:</span> <span class="n">dummy</span><span class="p">()</span> <span class="p">{}</span>
    <span class="o">~</span><span class="n">RecursiveUnion</span><span class="p">(){}</span>
  <span class="p">};</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">(</span><span class="n">RecursiveUnion</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Ts</span><span class="p">...</span><span class="o">&gt;&amp;</span> <span class="n">u</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">(</span><span class="n">U</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">get</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">others</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err">... </span><span class="nc">Ts</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">UnionStorage</span>
<span class="p">{</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="n">get</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">detail</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>

  <span class="n">detail</span><span class="o">::</span><span class="n">RecursiveUnion</span><span class="o">&lt;</span><span class="n">Ts</span><span class="p">...</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>Si on regarde <a href="https://godbolt.org/g/xu9fwh">l&rsquo;assembleur</a>, il s&rsquo;avère que les 2 versions sont exactement les mêmes.</p>

<p>Pour initialiser l&rsquo;objet avec une valeur, la version avec <code>std::aligned_union</code> doit utiliser un <a href="http://en.cppreference.com/w/cpp/language/new">placement new</a> qui empêche de rendre le constructeur <code>constexpr</code>. Ce qui par la même occasion s&rsquo;applique aussi au variant. Sans compter le problème du <code>reinterpret_cast</code> dans la fonction <code>get()</code>. Du coup, bien que cette version soit plus simple et que je ne mette pas <code>constexpr</code>, l&rsquo;union récursive est préférable.</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// std::in_place_index_t
</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">in_place_index_t</span>
<span class="p">{</span>
  <span class="k">explicit</span> <span class="n">in_place_index_t</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>(<code>RecursiveUnion</code> devient <code>VariadicUnion</code>)</p>


<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp">    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
    <span class="n">VariadicUnion</span><span class="p">(</span><span class="n">in_place_index_t</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">U</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">value</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">{}</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">I</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">U</span><span class="o">&gt;</span>
    <span class="n">VariadicUnion</span><span class="p">(</span><span class="n">in_place_index_t</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">U</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">others</span><span class="p">(</span><span class="n">in_place_index_t</span><span class="o">&lt;</span><span class="n">I</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">{}</span>
</code></pre></div>


<p>Puis on adapte les fonctions de <code>Variant</code>.
Le code final est plutôt gros alors je ne mets <a href="https://github.com/jonathanpoelen/jonathanpoelen.github.io/tree/source/resources/cpp_variant/variant3.cpp#l157">que le lien</a>
.</p>

<p>Pour éviter une condition particulière dans le code, l&rsquo;union possède un membre supplémentaire: <code>Uninit</code>, utilisé par <code>init</code>, <code>copy</code> et <code>destroy</code> pour représenter un variant sans valeur.</p>

<p>Il y a aussi une condition dans <code>operator=</code> pour choisir entre la fonction <code>copy</code> si les 2 éléments sont du même type ou les fonctions <code>destroy</code>+<code>init</code> dans le cas contraire. Cette condition peut être supprimée si:</p>

<ul>
<li>Tous les éléments ont un destructeur trivial: il n&rsquo;y a pas besoin de faire <code>destroy</code>+<code>init</code>.</li>
<li>La fonction <code>visit</code> peut prendre plusieurs variants en paramètre pour faire un switch allant de 0 à <code>(sizeof...(Ts) + 1) * (sizeof...(Ts) + 1)</code>.</li>
</ul>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/#mot-de-la-fin"><h2 id="mot-de-la-fin">Mot de la fin</h2></a>

<p>Bien que le variant actuel soit incomplet, il est utilisable et proche des implémentations actuelles. Mais il y a plusieurs petits détails qui ne sont pas approfondis ici:</p>

<ul>
<li>l&rsquo;optimisation sur type_index,</li>
<li>les différents moyens de remplacer une vtable (ici je n&rsquo;utilise que le if/else récursif),</li>
<li>le coût d&rsquo;utilisation d&rsquo;un objet en fonction de sa nature (par exemple: le compilateur dévirtualise-t-il les fonctions virtuelles venant d&rsquo;un membre de variant ?)</li>
<li>les unions récursives</li>
<li>et bien d&rsquo;autres</li>
</ul>

<p>Les prochains articles seront davantage axés sur la méta-programmation et indirectement reliés avec certains aspects du variant présentés ici.</p>

<p>Les sources sont disponibles sur <a href="https://github.com/jonathanpoelen/jonathanpoelen.github.io/tree/source/resources/cpp_variant">github</a>
.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-09-02T14:45:55">02 septembre 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/09/au-coeur-dun-variant/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="dc9b2e982ad7fe0bb2aca98f8a852275-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=au-c%25C5%2593ur-dun-variant&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f&amp;title=au-c%25C5%2593ur-dun-variant" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f09%2fau-coeur-dun-variant%2f&amp;name=au-c%25C5%2593ur-dun-variant" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="faites-parler-votre-compilateur"><span>
        <a href="#au-c%25C5%2593ur-dun-variant"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Au cœur d&#39;un variant"></i></a>
        <a href="#ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Ma vision de l&#39;accessibilité appliquée pour ce blog"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/02/faites-parler-votre-compilateur/">Faites parler votre compilateur</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#au-c%25C5%2593ur-dun-variant">Article suivant: Au cœur d&#39;un variant</a><br/>
        <a href="#ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog">Article précédent: Ma vision de l&#39;accessibilité appliquée pour ce blog</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-02-13T03:00:28">13 février 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>1 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/02/faites-parler-votre-compilateur/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#36040b481566e4b0e803b6ef73789061-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      <p>En C++, notre meilleur ami est le compilateur. Encore faut-il bien le configurer pour qu&rsquo;il nous crache un maximum d&rsquo;avertissements en pleine poire.
Hélas, il s&rsquo;avère que les options dépendent grandement du compilateur et de la version.</p>

<p>Du côté de Clang, il y a un <code>-Weverything</code> qui active absolument tous les warnings &ndash; dont certains que je qualifie de douteux &ndash;,
alors que pour Gcc, <code>-Wall</code> et <code>-Wextra</code> n&rsquo;activent pas tout.
Mais pour les 2, il n&rsquo;y a pas d&rsquo;option qui regroupe celle de débogage ou d&rsquo;analyse dynamique.
Du coup, pour chaque nouvelle version, il y a un nombre plus ou moins important de flag à ajouter.</p>

<p>De ce constat, et parce que je possède plusieurs formats de fichier à mettre à jour, je me suis fait un générateur qu&rsquo;on peut trouver sur mon github: <a href="https://github.com/jonathanpoelen/cpp-compiler-options">cpp-compiler-options</a>. Les fichiers générés sont dans le dossier <code>output</code> et couvrent clang-3.1 à 6.0 et gcc-4.7 à 7.1.</p>

<p>Petite astuce pour gcc et clang. On peut mettre des options dans un fichier et le donner au compilateur en préfixant le nom du fichier par <code>@</code>. Il y a un mémo dans le README.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-02-13T03:00:28">13 février 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/02/faites-parler-votre-compilateur/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="36040b481566e4b0e803b6ef73789061-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=faites-parler-votre-compilateur&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f&amp;title=faites-parler-votre-compilateur" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f02%2ffaites-parler-votre-compilateur%2f&amp;name=faites-parler-votre-compilateur" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="ma-vision-de-laccessibilit%C3%A9-appliqu%C3%A9e-pour-ce-blog"><span>
        <a href="#faites-parler-votre-compilateur"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Faites parler votre compilateur"></i></a>
        <a href="#de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: De Blogspot à Hugo, il a changé de peau"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/">Ma vision de l&#39;accessibilité appliquée pour ce blog</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#faites-parler-votre-compilateur">Article suivant: Faites parler votre compilateur</a><br/>
        <a href="#de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau">Article précédent: De Blogspot à Hugo, il a changé de peau</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2018-01-02T14:18:22">02 janvier 2018
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/accessibilite-web" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>accessibilite-web</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>16 minutes ;
  <a href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#1a9d6a59534c2a4e6ca564c7da302e80-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Pour changer de la programmation logicielle, je vais parler de l&rsquo;accessibilité d&rsquo;un site et des petits détails exaspérants que je rencontre sur la toile. Je pense qu&rsquo;une bonne partie parle à chacun, généralement on fait avec, simplement parce qu&rsquo;il n&rsquo;y a pas d&rsquo;autre choix, mais c&rsquo;est toujours frustrant de tomber dessus.</p>

<p>Pour le blog, j&rsquo;ai passé pas mal de temps sur un template déjà existant en touchant finalement un peu à toutes les parties CSS et HTML. Je vais ici parler un peu de couleur, de police, de lien, de la manière de disposer des cadres et quelques autres bricoles insignifiantes et par définition essentielles.</p>

<!--<p class="disclaimer"><strong class="disclaimer_title">Avertissement :</strong> 
Mon expérience dans le domaine se limite à ce blog et je n'ai pas la prétention d'être un pro du milieu. Ma manière d'aborder les problèmes peut être à l'antipode des bonnes pratiques, mais ce sont mes choix et, finalement, je les impose aux visiteurs comme le fait n'importe quel site :).
</p>
-->

<!-- c'est moâ qui décide :p !-->

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#plus-de-clics-moins-de-contenu"><h2 id="plus-de-clics-moins-de-contenu">Plus de clics, moins de contenu</h2></a>

<p>Depuis plusieurs années, une pratique courante consiste à multiplier les clics pour accéder à du contenu. Cela prend plusieurs formes, généralement à travers un menu sectionné sur une multitude de pages, des listes déroulantes ou du texte qui apparait au clic. De l&rsquo;intuitif comme ils disent.</p>

<p>Le défaut de vouloir tout cacher est de rendre difficile d&rsquo;accès l&rsquo;information:</p>

<ul>
<li>Il n&rsquo;est pas possible de faire une recherche de texte.</li>
<li>Si on ne sait pas dans quel menu aller, on finit par cliquer partout.</li>
<li>L&rsquo;information est diffuse sur plusieurs pages, c&rsquo;est beaucoup de manipulations, pénible et long. Encore plus s&rsquo;il faut naviguer sur plusieurs pages avec une connexion lente.</li>
</ul>

<p>Un des exemples typiques que je déteste est matérialisé par la <a href="https://cpp.developpez.com/faq/cpp/">FAQ de dvp</a>: chaque catégorie doit être déroulée pour qu&rsquo;apparaissent les questions. Résultat, depuis la mise en place de ce nouveau système, je ne la consulte plus puisque trouver une question approximative est une gageure. Il me faut trouver la catégorie, l&rsquo;éventuelle sous-catégorie, dérouler chacune et enfin pouvoir faire une recherche de texte sur le mot qui m&rsquo;intéresse dans la question (le moteur de recherche donne souvent beaucoup trop de résultats).</p>

<p>À contrario, les FAQs sur le site du gouvernement permettent un affichage de toutes les questions et/ou réponses ce qui permet une recherche rapide et une lecture continue.</p>

<p>Je trouve que le site <a href="https://doisjeutiliser.fr">doisjeutiliser.fr</a> donne un bon résumé de la situation. Et je suis d&rsquo;accord avec tous les autres contre-exemples.</p>

<p>De plus, comme le langage graphique est différent entre les logiciels et entre sites on ne sait pas toujours le comportement associé au clic ou au lien par manque d&rsquo;indicateur, on va au-devant de grosses surprises. Une icône qui représente une sous-catégorie déroulée pour tel site, mais enroulée pour un autre site. Un clic pour dérouler alors que cela ouvre une nouvelle page, voire pire, une nouvelle fenêtre ou, inversement, ouvrir dans un nouvel onglet un lien fait pour afficher un zone cachée (généralement, on tombe sur une page vide). Dans les 2 scénarios c&rsquo;est une mauvaise surprise.</p>

<p>Et certains ont la bonne idée de redéfinir (ou de simuler) les actions d&rsquo;une liste déroulante en supprimant toute action clavier. Tu veux atteindre &laquo;&nbsp;août&nbsp;&raquo; en appuyant sur <code>a</code> ? Fais autrement ! Avec un peu de chance, il faudra aussi cliquer sur le bouton &laquo;&nbsp;Ok&nbsp;&raquo; pour valider son choix. Il ne faudrait pas user la touche entrée&hellip;</p>

<p>Vous l&rsquo;aurez compris, je suis contre cette pratique du &laquo;&nbsp;clic pour apparaître&nbsp;&raquo; à outrance.
Pour prendre en exemple le blog, sur l&rsquo;ancien (blogspot) les archives sont déroulées par années et par mois. Avec une moyenne qui dépasse difficilement 2 articles/mois, en trouver un précis en moins de 2 clics mérite une médaille. Ici, les archives sont sur une page dédiée qui permet une vue d&rsquo;ensemble immédiate sans étaler les titres sur plusieurs lignes.</p>

<p>(On y notera la police monospace sur la date qui facilite le parcours vertical ;).)</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#disposition-générale-et-débordement"><h2 id="disposition-générale-et-débordement">Disposition générale et débordement</h2></a>

<p>De mon point de vue, un site web possède classiquement un en-tête, un menu et du contenu, le tout positionné dans un nombre restreint de possibilités. La grande différence se joue sur la gestion du vide. Càd, la place que va prendre un élément sur la page.</p>

<p>Il existe principalement 3 cas de figures:</p>

<ul>
<li>Prendre un maximum de place.</li>
<li>Mettre une limite maximum sur la largeur.</li>
<li>Avoir une largeur fixée.</li>
</ul>

<p>Une solution n&rsquo;est pas meilleure qu&rsquo;une autre, le choix dépend du design, du type de contenu et du dispositif d&rsquo;affichage. La plupart du temps le site prend toute la largeur jusqu&rsquo;à une taille raisonnable avant de permuter en taille fixe définie en pourcentage ou en pixel.</p>

<p>On peut très bien avoir un contenu qui prend toute la page quelle que soit la résolution, mais il faut être conscient qu&rsquo;une ligne trop grande est difficile à lire. Plus une ligne est longue ou un paragraphe dense, moins il y a de points de repère visuels pour &laquo;&nbsp;suivre&nbsp;&raquo; le texte. Cela augmente le risque de glisser à la ligne suivante au milieu d&rsquo;une phrase, de sauter une ligne ou relire la même au lieu de passer à la suivante. L&rsquo;extrême inverse étant le format colonne utilisé par les journaux ou magazines, mais difficile à reproduire sur un navigateur.</p>

<p>Concernant la disposition du menu, à priori, n&rsquo;importe laquelle fait l&rsquo;affaire. À gauche, à droite ou en haut, quelle importance ? Mais c&rsquo;est oublier un point essentiel: que faire quand un élément est trop grand ? La solution immédiate est simple: aller à la ligne. C&rsquo;est même le comportement par défaut des navigateurs sur les blocs de texte. Ouf, nous sommes sauvés, tout va bien dans le meilleur des mondes.</p>

<p>Sauf qu&rsquo;il existe aussi les images, les tableaux, les lecteurs vidéo et l&rsquo;ensemble des éléments dont un &laquo;&nbsp;saut de ligne&nbsp;&raquo; n&rsquo;est pas envisageable. Et là, c&rsquo;est le drame. Heureusement, il existe plein d&rsquo;horribles solutions.</p>

<p>Les exemples qui suivent sont faits avec une ligne de code qui ne fait pas de saut de ligne automatique.</p>

<ul>
<li>S&rsquo;adapter au plus grand.
<!-- <div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-biggest-normal.png" alt="" />
  <figcaption>Une apparence sans défaut.</figcaption>
</figure></div>
 -->
<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-biggest-flex-row.png" alt="" />
  <figcaption>Débordement par la droite.</figcaption>
</figure></div>

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-biggest-flex-row-reverse.png" alt="" />
  <figcaption>Débordement par la gauche. Le scroll disparaît. Au moins pour Firefox.</figcaption>
</figure></div>
</li>
<li>Compacter les éléments ou mettre dans un scroll.
<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-scroll.png" alt="" />
  <figcaption>Un scroll alors qu&#39;il y a de l&#39;espace à droite.</figcaption>
</figure></div>
</li>
<li>Cacher le surplus.
<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-hidden.png" alt="" />
  <figcaption>Il n&#39;y a plus moyen de lire le contenu qui déborde.</figcaption>
</figure></div>
</li>
<li>Superposer les éléments.
<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/box-above.png" alt="" />
  <figcaption>La partie droite cache une partie du contenu.</figcaption>
</figure></div>
</li>
</ul>

<p>Presque toutes ces images ont un point commun: un menu à droite. Ce n&rsquo;est pas anodin, il est difficile d&rsquo;avoir un menu à droite quand la partie gauche veut prendre sa place.</p>

<p>En déplaçant le menu à gauche, les problèmes de superposition contenu/menu disparaîssent d&rsquo;eux-mêmes. On peut alors laisser le bloc prendre une place optimale.</p>

<p>Mais il faut le faire intelligemment pour ne pas tomber sur le premier cas qui ajoute un scroll horizontal pour l&rsquo;ensemble du contenu. Vous vous imaginez devoir scroller pour lire une ligne ? Puis bon, les paragraphes qui deviennent des lignes de 3 kilomètres, non merci !</p>

<p>Il serait également bête de faire comme le second cas qui ajoute un scroll sur tous les éléments dépassant une certaine taille alors qu&rsquo;un énorme vide persiste sur la droite.</p>

<p>J&rsquo;ai assisté sur la doc de Hugo au passage d&rsquo;un gabarit full page à celui d&rsquo;une taille fixe et, malheureusement, chaque code se voyait estampillé d&rsquo;un scroll horizontal. Obligé de déplacer la souris dessus pour qu&rsquo;il s&rsquo;agrandisse automatiquement jusqu&rsquo;au bord droit de ma fenêtre. Ce qui rendait par la même occasion le scroll superflu. La seule question qui m&rsquo;est venue est &laquo;&nbsp;Pourquoi dois-je utiliser une souris ? Pourquoi ce n&rsquo;est pas l&rsquo;apparence par défaut ?&nbsp;&raquo;.</p>

<p>Bon ok, deux questions.</p>

<p>Pour le blog, mon choix s&rsquo;est porté sur un menu à gauche, un contenu sur plus au moins 60% de large pour le centrer, mais avec les contenus trop grands qui débordent un maximum avant le recourt au scroll. C&rsquo;est la disposition la plus pratique à mes yeux. Le résultat peut même être visible sur l&rsquo;avant-dernier article dont un code possède une ligne plus grande qu&rsquo;à l&rsquo;habitude.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#liens-zone-de-clic-et-surbrillance"><h2 id="liens-zone-de-clic-et-surbrillance">Liens, zone de clic et surbrillance</h2></a>

<p>Comment parler du web sans un petit mot sur les liens ? Le point central de la navigation internet et pourtant si difficile à cliquer pour moi.</p>

<p>J&rsquo;ai l&rsquo;impression de faire partie des gens dont la souris est invariablement attirée par la rangée de pixels non cliquable en plein milieu d&rsquo;un lien. C&rsquo;est systématique lorsque celui-ci est sur plusieurs lignes. Tout indique que je suis dessus: la couleur de fond du cadre qui change, celle du texte, la petite décoration qui apparaît. Tout, sauf le pointeur de souris. Mais il y a tellement de changement autour que ce détail ne se voit même plus.
<!-- Demande-moi de faire un gâteau, je te dirai que l'alarme incendie ne s'est pas déclenchée lorsque le four s'est enflammé. --></p>

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/menu-multi-line.png" alt="" />
  <figcaption>Clic... Clic ? Clic clic clic ! Comment ? Je ne suis pas dessus ?</figcaption>
</figure></div>


<p>Arrive mon second fléau, déplacer suffisamment la souris pour être sur le lien. Mais pas trop, parce que ce foutu cadre qui change de couleur n&rsquo;en fait pas partie non plus.</p>

<p>Le problème que je rencontre ici est récurant. Des changements de couleurs et de formes donnent l&rsquo;impression de pouvoir effectuer une action alors que ce n&rsquo;est pas vrai. Il vient alors un sentiment d&rsquo;incompréhension très désagréable qui se change petit à petit en frustration lorsqu&rsquo;on réalise que le pointeur de souris n&rsquo;a pas la bonne forme.</p>

<p>Quand un cadre contenant un lien change de couleur au passage de la souris, c&rsquo;est une invitation au clic. Celui-ci se doit d&rsquo;être cliquable pour répondre au principe de la moindre surprise. Bonus, cela élargit la surface de clic et rend par la même occasion le lien plus accessible.</p>

<!--<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/menu-hover-bad.png" alt="" />
  <figcaption>Contre toute attente, la souris n&#39;est pas sur le lien.</figcaption>
</figure></div>

VS.-->

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/menu-hover-good.png" alt="" />
  <figcaption>C&#39;est quand même plus agréable lorsque le cadre est un lien.</figcaption>
</figure></div>


<p>Cette extension de la zone de clic est très présente sur le blog. Comme les espaces blancs décoratifs sur le menu qui font partie du lien. Il est possible en plein écran de plaquer le curseur à gauche et de pouvoir cliquer dessus. Ou par exemple les liens &laquo;&nbsp;Précédent&nbsp;&raquo; et &laquo;&nbsp;Suivant&nbsp;&raquo; en fin d&rsquo;article qui prennent chacun une moitié de largeur de contenu. Ou encore les icônes de flux RSS qui possèdent une zone de clic réelle beaucoup plus grande que l&rsquo;image. Chacun de ces éléments possède une zone de clic plus large pour simplifier la visée.</p>

<p>Une dernière chose à éviter impérativement sur un lien concerne l&rsquo;application d&rsquo;un effet de gras au survol. Si par malheur le lien se situe en fin de ligne, la mise en gras va agrandir de quelques pixels les lettres et peut déplacer des mots à la ligne suivante. Qui se retrouvent en dehors de la zone de pointage. Qui reviennent car ne sont plus concernés par le survol. Puis repartent. Et ainsi de suite rendant le lien presque incliquable pour ceux ayant échappé à la crise d&rsquo;épilepsie. Bien sûr, si le lien est une boîte qui grandit ou ne se déplace pas, il n&rsquo;y a aucun problème.</p>

<p>À présent, parlons d&rsquo;une évidence: un lien doit être mis en surbrillance par rapport au reste du contenu. S&rsquo;il n&rsquo;y a aucun repère visuel qui le différencie, personne ne le remarquera. Dans l&rsquo;imaginaire collectif, un texte bleu ou violet et surtout souligné représente un lien. Bien que l&rsquo;on puisse le modifier, je déconseille d&rsquo;enlever le soulignement. Un simple changement de couleur pouvant être considéré comme une mise en gras.</p>

<p>En plus de la pseudo-classe <code>:hover</code> &ndash;source des problèmes cités au début du chapitre lorsqu&rsquo;elle est mal utilisée&ndash;, il est essentiel de mettre en valeur les liens possédant le focus (<code>:focus</code>) pour les adeptes de la navigation clavier. Certains navigateurs comme Opéra possèdent des raccourcis clavier très pratiques pour sauter de lien en lien, mais très handicapants lorsque le site n&rsquo;utilise pas ce marqueur visuel.</p>

<p>(Je profite du paragraphe pour parler des <a href="https://www.alsacreations.com/article/lire/572-Les-liens-d-evitement.html#menu">liens d&rsquo;évitement</a> (<a href="http://blog.atalan.fr/des-liens-devitement-astucieux/#categories">ici</a> et <a href="http://www.accede-web.com/notices/html-css-javascript/12-navigation-clavier/12-2-liens-evitement/">là</a>) pour sauter les regroupements de texte comme le menu et simplifier la vie des utilisateurs de clavier et autres dispositifs).</p>

<p>Pour finir sur les pseudo-classes et clore le sujet, je trouve que beaucoup de sites ignorent <code>:active</code>, alors que c&rsquo;est un excellent moyen d&rsquo;informer un visiteur que son clic est bien pris en compte. C&rsquo;est un indicateur qui manque souvent quand j&rsquo;ouvre dans un nouvel onglet: ai-je bien cliqué ? Cette information m&rsquo;est tellement essentielle que je force dans mon navigateur un cadre en pointillé rouge lorsque je valide un lien.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#la-police-des-caractères"><h2 id="la-police-des-caractères">La police des caractères</h2></a>

<p>Une chose que j&rsquo;ai apprise en testant plusieurs polices d&rsquo;écriture, est que la taille apparente varie énormément entre 2 fonts. Mettre une taille de police adaptée à la lecture n&rsquo;est pas suffisant, il faut aussi que chaque police dans la liste de <code>font-family</code> ait une taille similaire au risque d&rsquo;avoir des textes trop grands, ou pire, trop petits.</p>

<p>Je suis également tombé sur un conseil qui va à l&rsquo;encontre du bon sens: mettre un <code>font-size: 62.5%</code> global. Avec pour seule justification que la taille par défaut est trop grande. Sans prendre en compte la taille effective d&rsquo;une police et en rejetant toute configuration utilisateur. Si &laquo;&nbsp;62.5%&nbsp;&raquo; est trop petit, c&rsquo;est le problème de l&rsquo;utilisateur après tout.</p>

<table>
  <tr><th>Police</th><th>16px</th><th>10px (62.5%)</th></tr>
  <tr style="font-family: sans-serif">
    <td>Sans-serif</td>
    <td style="font-size: 16px">Lorem ipsum</td>
    <td style="font-size: 10px">Lorem ipsum</td>
  </tr>
  <tr style="font-family: Arial">
    <td>Arial</td>
    <td style="font-size: 16px">Lorem ipsum</td>
    <td style="font-size: 10px">Lorem ipsum</td>
  </tr>
  <tr style="font-family: 'Times New Roman'">
    <td style="font-size: 16px">Times New Roman</td>
    <td style="font-size: 16px">Lorem ipsum</td>
    <td style="font-size: 10px">Lorem ipsum</td>
  </tr>
  <tr style="font-family: Times">
    <td style="font-size: 16px">Times</td>
    <td style="font-size: 16px">Lorem ipsum</td>
    <td style="font-size: 10px">Lorem ipsum</td>
  </tr>
</table>

<p>Étrangement, il n&rsquo;y a que sur internet où la taille est redéfinie. Sur une application de bureau personne ne s&rsquo;en occupe et les polices et tailles configurées au niveau du système sont utilisées automatiquement pour les différents types d&rsquo;éléments (titre, paragraphe, police monospace, etc).</p>

<p>Mon seul conseil pour <code>font-size</code> est d&rsquo;appliquer le différentiel entre Serif/Sans-Serif et la police choisie car Serif ou Sans-Serif ont un différentiel de <a href="https://fr.wikipedia.org/wiki/Jambage">jambage</a> supérieur et inférieur égal au nombre de pixels demandé.</p>

<p>Comme on parle d&rsquo;<a href="https://fr.wikipedia.org/wiki/Empattement_(typographie)">empattement</a> (serif ou sans-serif), j&rsquo;en suis venu à la conclusion qu&rsquo;une police sans empattement est plus lisible sur un écran. Peut-être à cause de la petitesse des lettres qui &laquo;&nbsp;charge&nbsp;&raquo; visuellement les glyphes. Ou Le rétro-éclairage, je ne sais pas.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#le-pouvoir-de-la-couleur"><h2 id="le-pouvoir-de-la-couleur">Le pouvoir de la couleur</h2></a>

<p>La couleur est un vecteur d&rsquo;information aussi importante &ndash;voire plus&ndash; que la forme. Par contre, il faut utiliser la couleur d&rsquo;usage sur l&rsquo;objet représenté au risque de perturber le lecteur.</p>

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/ok-cancel.png" alt="" />
  <figcaption>Perturbant, n&#39;est-ce pas ?</figcaption>
</figure></div>


<p>La couleur et les effets permettent également de distinguer les éléments entre eux. Par exemple, une légère ombre sur un bouton lui donne un relief qui le distingue d&rsquo;un cadre lambda. Mais il faut savoir varier. Si je prends comme exemple les boutons sociaux, il est difficile d&rsquo;en trouver un précisément lorsqu&rsquo;ils sont tous de la même couleur.</p>

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/social-gray.png" alt="" />
  <figcaption>Y a-t-il ton réseau préféré ?</figcaption>
</figure></div>


<p>Alors que mettre la couleur habituellement utilisée par une marque permet de se focaliser presque sans effort dessus.</p>

<div class="figure"><figure>
  <img src="/post/ma-vision-de-l-accessibilite-applique-pour-ce-blog/social-color.png" alt="" />
  <figcaption>Et maintenant ?</figcaption>
</figure></div>


<p>Même si les couleurs du site sont banales, je me permets quelques remarques. Premièrement, il vaut mieux se restreindre à un nombre raisonnable de couleurs, mais suffisamment contrastées pour les dissocier. Trop de couleurs empêchent de hiérarchiser l&rsquo;information, un contraste trop faible de dissocier les éléments ce qui rend illisible le texte.</p>

<p>Il existe différents outils pour faire des palettes de couleurs qu&rsquo;on peut fabriquer avec le logiciel <a href="https://doc.ubuntu-fr.org/agave">Agave</a>, le très bon site <a href="https://color.adobe.com/fr/create/color-wheel">Adobe Kuler</a>, <a href="https://colourco.de">colourco.de</a> ou <a href="http://www.code-couleur.com/">code-couleur.com</a> qui liste quelques palettes de couleurs. Ce dernier contient également la signification de certaines couleurs dans le monde occidental. Je trouve intéressant d&rsquo;ajouter cet <a href="https://alfange.com/graphisme-10-couleurs-signification/">article trouvé sur la toile</a> pour voir un peu &ndash;bien que difficile à vérifier&ndash; l&rsquo;évolution et usage au fil du temps. En cherchant un peu, on tombe sur pléthore de sites et de conseils. On a l&rsquo;embarras du choix.</p>

<p>Si je peux donner un conseil, évitez les couleurs trop pures ; celles qui contiennent une composante de couleur proche de 255 et les autres à 0 comme pour les couleurs primaires (ex: <code>#ff0000</code>). Ce sont des couleurs très prononcées, pas du tout naturelles. Je trouve qu&rsquo;elles brillent trop et agressent les yeux.</p>

<p>Une dernière chose concernant les couleurs, tout le monde ne les voit pas de la même façon, essayer un filtre pour <a href="https://www.toptal.com/designers/colorfilter">simuler le daltonisme</a> est une expérience intéressante.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#les-métadonnées-sont-importantes"><h2 id="les-métadonnées-sont-importantes">Les métadonnées sont importantes !</h2></a>

<p>Les métadonnées sont toutes les informations relatives à un document qui permettent notamment de le replacer dans un contexte sans le supposer après lecture de plusieurs paragraphes (même ainsi, certains éléments sont impossibles à déduire). Elles sont tellement importantes qu&rsquo;il est possible de déduire le contenu du document associé sans l&rsquo;avoir jamais lu.</p>

<p>J&rsquo;exagère un peu, mais si on prend un article de blog et qu&rsquo;on a l&rsquo;habitude de lire les commentaires de l&rsquo;auteur sur des forums, on se fait une relativement bonne idée du contenu de ses écrits. Mais pour cela il faut au moins avoir le nom de l&rsquo;auteur, le sujet principal (titre, domaine du sujet) et probablement la date. Cela paraît évident, mais des fois, un ou plusieurs éléments manquent. Grossièrement, ce sont pour moi des marqueurs qui permettent de filtrer les lectures potentiellement intéressantes et de se préparer mentalement.</p>

<p>Plus généralement, les métadonnées sont un moyen de mettre en relation des données avec d&rsquo;autres via des <a href="https://fr.wikipedia.org/wiki/Uniform_Resource_Identifier">URIs</a> dans le but de faire des requêtes extrêmement sophistiquées à la manière de SQL (<a href="https://fr.wikipedia.org/wiki/SPARQL">SPARQL</a>). On parle aussi de <a href="https://fr.wikipedia.org/wiki/Web_sémantique">web sémantique</a> que je trouve une très bonne idée pour des ressources ayant beaucoup de relations, de dépendances, etc comme les encyclopédies ou des documents de normalisation, mais c&rsquo;est un travail de longue haleine et franchement superflu dans le cadre d&rsquo;un blog.</p>

<p>Donc voilà, les métadonnées c&rsquo;est cool, mais je me contente de quelques informations en tête et pied d&rsquo;article. On peut aussi les retrouver de manière plus structurée dans le <a href="/index.xml">flux RSS</a>.</p>

<p>Parmi les informations qui gravitent autour des articles ici, on trouve:</p>

<ul>
<li>Les catégories, car c&rsquo;est un moyen facile de centrer le domaine d&rsquo;application et filtrer les contenus.</li>
<li>La date, parce qu&rsquo;une information se périme vite. Les bonnes pratiques d&rsquo;hier sont les mauvaises pratiques de demain. Et si je parle d&rsquo;hier, on sait au moins de quel hier je fais référence.</li>
<li>La date de dernière mise à jour s&rsquo;il y a lieu. Il y a aussi une entrée dédiée dans le menu. Pour le moment je ne sais pas comment mettre en valeur les changements, peut-être une note en pied de page ?</li>
<li>Le temps de lecture. C&rsquo;est un bête calcul en fonction du nombre de mots qui peut être plus précis que la taille du scroll en présence d&rsquo;image.
Et comme la page d&rsquo;accueil contient plusieurs articles, la taille du scroll n&rsquo;est pas une information fiable.</li>
<li>L&rsquo;auteur, même si pour le coup il n&rsquo;y aura &ndash; probablement &ndash; que moi.</li>
<li>Le lien permanent et les boutons de partage pour conquérir le monde.<!-- Comme chaque soir Minus.--></li>
</ul>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#les-commentaires"><h2 id="les-commentaires">Les commentaires</h2></a>

<p>Sur un site statique, il n&rsquo;est pas possible d&rsquo;intégrer son propre système de commentaire. On peut utiliser un service web comme <a href="https://disqus.com">disqus.com</a> qui est très bien fait, mais aussi lourd et lent à charger.</p>

<p>C&rsquo;est un reproche qui peut se faire sur beaucoup de sites. À force d&rsquo;incorporer nombre de services externes (pour certains discutables), le site est ralenti et perd en fluidité.</p>

<p>Comme je pense qu&rsquo;un espace commentaire est toujours intéressant, je tenais vraiment à en avoir un sur le blog. Alors je me suis dit, quitte à utiliser github.io, autant y aller jusqu&rsquo;au bout et me servir des issues de github comme système d&rsquo;échange. Ce n&rsquo;est pas aussi bien intégré dans la page qu&rsquo;un système natif (il faut passer par github pour poster), mais cela fait son job. Je perds par contre les commentaires anonymes puisqu&rsquo;il faut un compte pour poster.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/#mais-encore"><h2 id="mais-encore">Mais encore</h2></a>

<p>À vrai dire, il y a pas mal de petites choses non citées qui m&rsquo;agacent beaucoup (titre tronqué devenant trop court, animation trop lente, etc), mais ce sont des conseils qu&rsquo;on peut retrouver assez facilement sur la toile.</p>

<p>J&rsquo;ai davantage axé mes propos sur des détails que je trouve peu discutés. Tellement peu évoqués que j&rsquo;ai l&rsquo;impression d&rsquo;être le seul concerné. Pour dire. Mais si cela permet de faire réfléchir, tant mieux.</p>

<p>Après, c&rsquo;est bien possible que n&rsquo;étant pas spécialement attiré par les technos web, un site spécialisé que je ne connais pas en parle mieux que moi. Tant mieux aussi.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2018-01-02T14:18:22">02 janvier 2018
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/accessibilite-web" rel="category">accessibilite-web</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2018/01/ma-vision-de-laccessibilite-appliquee-pour-ce-blog/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="1a9d6a59534c2a4e6ca564c7da302e80-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f&amp;title=ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2018%2f01%2fma-vision-de-laccessibilite-appliquee-pour-ce-blog%2f&amp;name=ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="de-blogspot-%C3%A0-hugo-il-a-chang%C3%A9-de-peau"><span>
        <a href="#ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: Ma vision de l&#39;accessibilité appliquée pour ce blog"></i></a>
        <a href="#minimiser-les-copies-dans-operator%2b"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Minimiser les copies dans operator&#43;"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/">De Blogspot à Hugo, il a changé de peau</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#ma-vision-de-laccessibilit%25C3%25A9-appliqu%25C3%25A9e-pour-ce-blog">Article suivant: Ma vision de l&#39;accessibilité appliquée pour ce blog</a><br/>
        <a href="#minimiser-les-copies-dans-operator%2b">Article précédent: Minimiser les copies dans operator&#43;</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2017-07-29T16:03:53">29 juillet 2017
</time>
    
    ;
  

  

  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>5 minutes ;
  <a href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/#gh-comments" onclick="DoGithubComments( 0 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#96a58f4e3d0ef332dd3ad4bb99d219c5-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Il y a 2 ans je me suis dit :</p>

<blockquote>
<p>Au prochain article, j&rsquo;essaye un autre système de blog !</p>
</blockquote>

<p>Et depuis 2 ans, plus rien&hellip; Je n&rsquo;ai pas parcouru le web à la recherche de la solution idéale, loin de là, je n&rsquo;avais juste pas d&rsquo;idée d&rsquo;article.</p>

<p>Il y a 3 mois, en regardant une classe de matrice en C++, une idée m&rsquo;est venue. J&rsquo;ai écrit mon article puis cherché un système de site statique.</p>

<p>Au départ, j&rsquo;avais en tête <a href="http://octopress.org/">Octopress</a> utilisé par Luc Hermitte pour son <a href="http://luchermitte.github.io/">blog</a>. Le principe est d&rsquo;écrire des fichiers en markdown, de générer le blog et mettre le tout sur github pour avoir une adresse en <code>github.io</code>. Le mettre sur github n&rsquo;est pas une obligation, mais c&rsquo;est pour moi le plus simple.</p>

<p>J&rsquo;ai donc essayé <a href="https://github.com/gohugoio/hugo">Hugo</a>&hellip; Ma logique est infaillible :).</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/#pourquoi-quitter-blogspot"><h2 id="pourquoi-quitter-blogspot">Pourquoi quitter Blogspot ?</h2></a>

<p>Avant de commencer, une petite explication sur pourquoi Blogspot ne m&rsquo;est pas pratique.</p>

<p>La principale raison est que l&rsquo;utilisation de Blogspot m&rsquo;oblige à faire du post-traitement sur mes articles. Pour avoir la couleur dans les codes, ils sont écrits dans un éditeur puis convertits en HTML (via Kate dans mon cas). La couleur de fond est trop contrastée pour le blog ce qui oblige un post-traitement supplémentaire. L&rsquo;ensemble est plutôt rapide à faire, mais modifier un code est pénible.</p>

<p>Puisque je suis dans le mode HTML de blogspot, je me tape aussi tout le balisage des liens, paragraphes, mots importants, etc, ce qui parasite le texte. L&rsquo;absence de couleur dans la zone d&rsquo;édition n&rsquo;aide pas beaucoup.</p>

<p>Autre point, j&rsquo;écris rarement un article depuis l&rsquo;interface web. Déjà parce qu&rsquo;il faut y accéder &ndash; il y a un peu trop de clics à faire et Blogspot reste lent à charger &ndash; ensuite parce que l&rsquo;éditeur est trop pauvre. Ça paraît con, mais les possibilités de mon éditeur de code sont très sollicités, même pour l&rsquo;écriture d&rsquo;un article. J&rsquo;envisage même de faire des plugins pour de la saisie rapide.</p>

<p>Ceci fait qu&rsquo;utiliser un générateur de type markdown me trottait dans la tête depuis un bon moment. Il existe plein de générateurs vers HTML, <a href="http://pandoc.org/">Pandoc</a> étant probablement le plus connu. C&rsquo;est suffisant. On écrit un article, on convertit et on colle la sortie dans la zone d&rsquo;édition du blog.</p>

<p>J&rsquo;aurais très bien pu utiliser Blogspot + un générateur. Sauf que je trouve Blogspot lourd à charger et les possibilités de menu et de mise en page sont un peu limitées. Alors autant voir ailleurs !</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/#essai-de-hugo"><h2 id="essai-de-hugo">Essai de Hugo</h2></a>

<p>En fait, au moment où je commençais à regarder les systèmes existants, quelqu&rsquo;un sur le <a href="https://openclassrooms.com/forum/sujet/groupe-communautaire-groupe-42">MM de 42</a> mit un lien vers Hugo. Le principe reste le même &ndash; au moins pour la génération de blog &ndash; avec comme objectif principal de ne pas avoir de dépendance et de générer rapidement le site.</p>

<p>Un truc qui me plaît bien est de pouvoir utiliser autre chose que le markdown par défaut, par exemple, <a href="http://asciidoc.org/">Asciidoctor</a> ou <a href="http://docutils.sourceforge.net/rst.html">ReStructuredText</a>. Les implémentations ne sont pas nativement incorporées à Hugo ce qui rend leur utilisation plus lente dans la génération (il faut appeler un programme externe). Toutefois, il y a en native 2 implémentaitons de <a href="https://gohugo.io/content-management/formats/">markdown</a> et le <a href="http://orgmode.org/">mode Org</a> de Emacs. Pour se faire une idée du mode org, il y a 3 traductions françaises dont 2 à venir de <a href="pragmatic_emacs">Pragmatic Emacs</a> sur <a href="linuxfr_org">linuxfr</a>.</p>

<p>J&rsquo;ai essayé Asciidoc, mais il ne fonctionne pas tel quel, il m&rsquo;a fallu un intermédiaire qui supprime l&rsquo;option <code>--safe</code> pour la coloraion du code (celle-ci utilise <a href="pygmentize">Pygmentize</a>). Par contre, je trouve le code HTML généré vraiment trop verbeux. À mon sens, entourer les paragraphes de <code>&lt;div class=&quot;paragraph&quot;&gt;...&lt;/div&gt;</code> est plus que superflux. Je ne sais pas ce qu&rsquo;il en est des autres formats ne les ayant pas essayés, pour le moment mes besoins suffisent pour le markdown. À savoir que les formats non natifs ne peuvent pas générer le sommaire, il faut faire un post-traitement sur la sortie HTML.</p>

<p>Une autre chose sympathique que je n&rsquo;ai pas eu l&rsquo;occasion d&rsquo;utiliser concerne les templates Hugo au sein même des documents. Par exemple, un template <code>image</code> qui sort un code HTML avec caption + figure + image de la bonne taille + lien pour voir l&rsquo;image d&rsquo;origine. En gros, générer un truc bien casse pied à écrire :).</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/#et-octopress"><h2 id="et-octopress">Et Octopress ?</h2></a>

<p>Bon Hugo c&rsquo;est bon pour moi, mais j&rsquo;ai rapidement fait un tour sur Octopress entre deux. Pour tout dire, j&rsquo;ai rapidement abandonné. Le plugin le plus intéressant pour moi est <a href="http://octopress.org/docs/plugins/codeblock/">Codeblock</a> et il ne fonctionne pas comme indiqué. J&rsquo;ai regardé les sources et finalement renoncé.</p>

<p>Au passage, je remarque que le projet n&rsquo;est plus maintenu depuis plusieurs années et qu&rsquo;il se base sur <a href="jekyll">Jekyll</a>. J&rsquo;essaye ce dernier et me retrouve avec des problèmes de dépendances et des packageurs &ndash; il y en a pas qu&rsquo;un &ndash; qui demandent les droits root pour l&rsquo;installation. Las, j&rsquo;abandonne. Finalement, Hugo c&rsquo;est bien.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/#pour-finir"><h2 id="pour-finir">Pour finir</h2></a>

<p>J&rsquo;ai beaucoup touché au template de Hugo, aussi bien la partie CSS que HTML en me basant sur un des thèmes disponibles. À la base je voulais un thème sombre, mais j&rsquo;ai finalement adopté un thème clair pour le contenu. Premièrement parce que le thème choisi l&rsquo;est de base, deuxièmement parce que je trouve le résultat peu satisfaisant. Toutefois, le thème sombre est disponible en le sélectionnant dans le menu du navigateur: Vue -&gt; Style de page -&gt; Night theme (sur firefox, cela varie peut-être sur d&rsquo;autres navigateurs). À terme, je pense chavirer du côté obscur.</p>

<p>La plupart des morceaux modifiés concernent des éritants que je rencontre sur certains sites et logiciels. J&rsquo;ai essayé de faire quelque chose d&rsquo;accessible et de pratique (là je vous vends un objet rare et de grande valeur :D). Du coup, le prochain article y sera consacré. Ça va me changer du c++ et de la méta-programmation.</p>

<p>Et parce que les habitudes ont la vie dure, l&rsquo;article qui suivra sera dédié au dispatcheur d&rsquo;un std::variant. La méta-prog, on ne la quitte que les pieds devant :o).</p>

<p>En même temps, les articles de l&rsquo;ancien blog seront déportés et mis à jour si besoin.</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2017-07-29T16:03:53">29 juillet 2017
</time> par Jonathan Poelen ;
  

  <br/><a href="https://jonathanpoelen.github.io/2017/07/de-blogspot-a-hugo-il-a-change-de-peau/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="96a58f4e3d0ef332dd3ad4bb99d219c5-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f&amp;title=de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fde-blogspot-a-hugo-il-a-change-de-peau%2f&amp;name=de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>

        
<article class="post">
  <header class="post__header clearfix">
    <div class="post__title-nextprev" id="minimiser-les-copies-dans-operator&#43;"><span>
        <a href="#de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau"><i class="fas fa-caret-square-up" aria-hidden="true" title="Article précédent: De Blogspot à Hugo, il a changé de peau"></i></a>
        <a href="#comment-se-passer-de-stdforward"><i class="fas fa-caret-square-down" aria-hidden="true" title="Article suivant: Comment se passer de std::forward"></i></a>
    </span></div>
    <h1 class="post__title"><a href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/">Minimiser les copies dans operator&#43;</a></h1>
    <div class="post__title-nextprev-text sr-only">
        <a href="#de-blogspot-%25C3%25A0-hugo-il-a-chang%25C3%25A9-de-peau">Article suivant: De Blogspot à Hugo, il a changé de peau</a><br/>
        <a href="#comment-se-passer-de-stdforward">Article précédent: Comment se passer de std::forward</a><br/>
    </div>
    
<p class="post__meta meta">
    <i class="fas fa-clock-o fa-fw" aria-hidden="true"></i>
    <time class="post__meta-date" datetime="2017-07-05T22:02:11">05 juillet 2017
</time>
    
    ;
  

  

<a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category"><i class="fas fa-folder fa-fw" aria-hidden="true"></i><span class="sr-only text-alt">Catégories&nbsp;:</span>c&#43;&#43;</a>
;


  <i class="fas fa-hourglass-start fa-fw" aria-hidden="true"></i><span class="sr-only text-alt fa-fw">Durée de lecture éstimée&nbsp;:</span>9 minutes ;
  <a href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/#gh-comments" onclick="DoGithubComments( 1 )"><i class="fas fa-comments fa-fw" aria-hidden="true"></i>Commentaires</a> ;
  <a href="#8d66709af0c9e47357d2fae8b9c175bd-share"><i class="fas fa-share-alt fa-fw" aria-hidden="true"></i>Partager</a>
</p>


  </header>
  <div class="post__content">
      

<p>Je vais me baser sur un classique: une classe de matrice contenant un <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>
</code></span>. Cette classe va implémenter 2 opérateurs mathématiques: <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="o">+</span>
</code></span> et <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="o">+=</span>
</code></span>. Le premier en fonction libre, le second en fonction membre.</p>

<p>Pour rigoler un peu, on ajoute une petite contrainte qui est &laquo;&nbsp;l&rsquo;efficacité&nbsp;&raquo;. Petit mot qui englobe un peu tout et n&rsquo;importe quoi tel que la performance en mémoire et en temps.</p>

<p>À vrai dire, il y a énormément de choses possibles rien que sur la structure du code: instruction vectorisée, alignement mémoire, expression template, etc. Des bibliothèques comme uBLAS, Eigen, Blitz implémentent une tripotée de choses. Ici, on va uniquement s&rsquo;intéresser à la manière d&rsquo;implémenter <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">operator</span><span class="o">+</span>
</code></span> pour recycler les variables temporaires dans le but d&rsquo;avoir le moins d&rsquo;allocations possibles dûes aux copies.</p>

<p>Grosso-modo, des rvalues à droite, des rvalues à gauche, des rvalues partout et pour finir, pas de rvalue.</p>

<p>En réalité, il y a plusieurs approches possibles que je mets ici en opposition sans qu&rsquo;elles le soient réellement.</p>

<ol>
<li>une surcharge pour tous les prototypes possibles.</li>
<li>un opérator unique pour les gouverner tous.</li>
</ol>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/#plein-de-surcharges-de-operator"><h2 id="plein-de-surcharges-de-operator">Plein de surcharges de operator+</h2></a>

<p>Faire 4 prototypes pour distinguer les rvalues des lvalues est un choix assez naturel. Si un prototype contient une rvalue, alors il y a moyen de recycler une valeur. On pourrait même ajouter <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">noexcept</span>
</code></span> sur de tels prototypes.</p>

<p>Voici ce que donne l&rsquo;implémentation:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Matrix</span> <span class="n">ret</span> <span class="p">{</span><span class="n">lhs</span><span class="p">};</span>
  <span class="n">ret</span> <span class="o">+=</span> <span class="n">rhs</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span> <span class="c1">// et non pas return `ret += rhs`, ce qui empêcherait la NRVO.
</span><span class="c1"></span><span class="p">}</span>

<span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span><span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lhs</span> <span class="o">+=</span> <span class="n">rhs</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span> <span class="c1">// ne pas oublier std::move, sinon il y a aura copie en sortie
</span><span class="c1"></span><span class="p">}</span>

<span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rhs</span> <span class="o">+=</span> <span class="n">lhs</span><span class="p">;</span> <span class="c1">// commutativité: x+y = y+x
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span><span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rhs</span> <span class="o">+=</span> <span class="n">lhs</span><span class="p">;</span> <span class="c1">// éventuellement `rhs += std::move(lhs)`
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Petite note sur la dernière implémentation. Utiliser <code>rhs</code> comme valeur de retour permet de gagner un <code>mov</code> (asm). <a href="https://godbolt.org/#g:!((g:!((g:!((h:codeEditor,i:(j:1,source:'%23include+%3Cutility%3E%0A%23include+%3Cvector%3E%0A%0Astruct+Matrix%0A%7B%0A++++++std::vector%3Cint%3E+v%3B%0A++++++Matrix%26+operator+%2B%3D(Matrix+const%26)+%3B%0A%7D%3B%0A%0AMatrix+operator%2B+(Matrix+%26%26+lhs,+Matrix+const+%26+rhs)%0A%7B%0A++++std::move(lhs)+%2B%3D+rhs%3B%0A++++//+ne+pas+oublier+std::move,+sinon+il+y+a+aura+copie+en+sortie+puisque+que+lhs+est+une+r%C3%A9f%C3%A9rence%0A++++return+std::move(lhs)%3B%0A%7D%0A%0AMatrix+operator+%2B+(Matrix+const+%26+lhs,+Matrix+%26%26+rhs)%0A%7B%0A++++std::move(rhs)+%2B%3D+lhs%3B+//+commutativit%C3%A9:+x%2By+%3D+y%2Bx%0A++++return+std::move(rhs)%3B%0A%7D%0A'),l:'5',n:'0',o:'C%2B%2B+source+%231',t:'0')),k:31.812073713509285,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:g71,filters:(b:'0',commentOnly:'0',directives:'0',intel:'0'),options:'-O3+-std%3Dc%2B%2B14+-fverbose-asm+',source:1),l:'5',n:'0',o:'x86-64+gcc+7.1+(Editor+%231,+Compiler+%231)',t:'0')),k:34.07627444894807,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:g71,filters:(b:'0',commentOnly:'0',directives:'0',intel:'0'),options:'+-std%3Dc%2B%2B14+-O3+-fverbose-asm+',source:1),l:'5',n:'0',o:'x86-64+gcc+7.1+(Editor+%231,+Compiler+%232)',t:'0')),k:34.11165183754265,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4">ici</a>.</p>

<p>Bon, c&rsquo;est bien joli, mais on peut quasiment faire la même avec seulement 2 prototypes. Seulement, pour une raison que j&rsquo;ignore, ni clang, ni gcc n&rsquo;applique la RVO correctement. Le constructeur de déplacement est systèmatiquement utilisé.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">lhs</span> <span class="o">+=</span> <span class="n">rhs</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">lhs</span><span class="p">;</span> <span class="c1">// pas de RVO ???
</span><span class="c1"></span><span class="p">}</span>

<span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rhs</span> <span class="o">+=</span> <span class="n">lhs</span><span class="p">;</span> <span class="c1">// commutativité: x+y = y+x
</span><span class="c1"></span>  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rhs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Les prototypes ne sont pas symétriques pour éviter les ambiguïtés. Le prototype prenant un paramètre par copie sera moins prioritaire que celui avec une rvalue, mais il accepte toutes les formes de référence.</p>

<p>Ainsi, si dans l&rsquo;expression <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">b</span>
</code></span> une rvalue, la seconde fonction sera utilisée. Dans les autres cas, la première fonction sera utilisée. On peut facilement vérifier quelle expression correspond à quelle fonction avec un <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">__PRETTY_FUNCTION__</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span>
</code></span> dans les implémentations et le test qui suit.</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">Lhs</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">Rhs</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">test</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Matrix &#34;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_const</span><span class="o">&lt;</span><span class="n">Lhs</span><span class="o">&gt;</span><span class="p">{}</span> <span class="o">?</span> <span class="s">&#34;const&#34;</span> <span class="o">:</span> <span class="s">&#34;     &#34;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; a; &#34;</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Matrix &#34;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_const</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;</span><span class="p">{}</span> <span class="o">?</span> <span class="s">&#34;const&#34;</span> <span class="o">:</span> <span class="s">&#34;     &#34;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; b;</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">;</span>

  <span class="n">Lhs</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">Rhs</span> <span class="n">b</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">left</span><span class="p">;</span>
  <span class="cp">#define C(a,b) std::cout &lt;&lt; std::setw(13) &lt;&lt; #a &lt;&lt; &#34;+ &#34; &lt;&lt; std::setw(15) &lt;&lt; #b; a+b
</span><span class="cp"></span>  <span class="n">C</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>            <span class="n">b</span><span class="p">);</span>
  <span class="n">C</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>            <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
  <span class="n">C</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
  <span class="n">C</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
  <span class="cp">#undef C
</span><span class="cp"></span><span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">test</span><span class="o">&lt;</span>      <span class="n">Matrix</span><span class="p">,</span>       <span class="n">Matrix</span><span class="o">&gt;</span><span class="p">();</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">test</span><span class="o">&lt;</span>      <span class="n">Matrix</span><span class="p">,</span> <span class="k">const</span> <span class="n">Matrix</span><span class="o">&gt;</span><span class="p">();</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">test</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Matrix</span><span class="p">,</span>       <span class="n">Matrix</span><span class="o">&gt;</span><span class="p">();</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">test</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Matrix</span><span class="p">,</span> <span class="k">const</span> <span class="n">Matrix</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>Résultat:</p>

<pre><code>Matrix       a; Matrix       b;

a            + b              Matrix operator+(Matrix, const Matrix&amp;)
a            + std::move(b)   Matrix operator+(const Matrix&amp;, Matrix&amp;&amp;)
std::move(a) + b              Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + std::move(b)   Matrix operator+(const Matrix&amp;, Matrix&amp;&amp;)


Matrix       a; Matrix const b;

a            + b              Matrix operator+(Matrix, const Matrix&amp;)
a            + std::move(b)   Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + b              Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + std::move(b)   Matrix operator+(Matrix, const Matrix&amp;)


Matrix const a; Matrix       b;

a            + b              Matrix operator+(Matrix, const Matrix&amp;)
a            + std::move(b)   Matrix operator+(const Matrix&amp;, Matrix&amp;&amp;)
std::move(a) + b              Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + std::move(b)   Matrix operator+(const Matrix&amp;, Matrix&amp;&amp;)


Matrix const a; Matrix const b;

a            + b              Matrix operator+(Matrix, const Matrix&amp;)
a            + std::move(b)   Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + b              Matrix operator+(Matrix, const Matrix&amp;)
std::move(a) + std::move(b)   Matrix operator+(Matrix, const Matrix&amp;)
</code></pre>

<p>Si on y tient vraiment, on peut ajouter <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">Matrix</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Matrix</span><span class="o">&amp;&amp;</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&amp;&amp;</span><span class="p">)</span>
</code></span>. Mais comme dit précédemment le besoin est très faible.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/#un-prototype-multi-fonction"><h2 id="un-prototype-multi-fonction">Un prototype multi-fonction</h2></a>

<p>Une autre solution pour la surcharge d&rsquo;opérateur est de ne faire qu&rsquo;un seul et unique prototype template qui s&rsquo;active en présence d&rsquo;un certain type. Ce n&rsquo;est pas une approche opposée à la précédente (elle peut servir de complément), mais je vais présenter ici comment le faire avec seulement un prototype.</p>

<p>Pour filtrer les types compatibles, on va utiliser la bonne vieille méthode à base de <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">enable_if</span>
</code></span>. Ce qui donne:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">MatrixLhs</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">MatrixRhs</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">MatrixLhs</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">decay_t</span><span class="o">&lt;</span><span class="n">MatrixRhs</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
  <span class="n">Matrix</span><span class="o">&gt;</span>
<span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">MatrixLhs</span><span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">MatrixRhs</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">);</span>
</code></pre></div>
<p>Dans la réalité, l&rsquo;addition d&rsquo;une matrice fonctionne aussi sur des entiers (cf: <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="o">+</span> <span class="n">Matrix</span>
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">Matrix</span> <span class="o">+</span> <span class="kt">int</span>
</code></span>). Le filtre sera alors beaucoup plus compliqué puisqu&rsquo;il faut qu&rsquo;au moins une des opérandes soit un type <code>Matrix</code> et que les paramètres soient des types compatibles (en prenant en compte la présence des références et des <code>const</code>). La condition devient alors quelque chose comme:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">is_matrix_operand</span><span class="o">&lt;</span><span class="n">Lhs</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span>
<span class="n">is_matrix_operand</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span>
<span class="p">(</span><span class="n">is_matrix</span><span class="o">&lt;</span><span class="n">Lhs</span><span class="o">&gt;</span> <span class="o">||</span> <span class="n">is_matrix</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div>
<p>Il devient alors très facile d&rsquo;ajouter un nouveau type à prendre en compte, comme par exemple un conteneur de la SL, un tableau C, un autre type matriciel d&rsquo;une autre bibliothèque, etc. Faire comme dans le premier chapitre avec un prototype pour chaque cas devient vite infernal.</p>

<p>Il est également envisageable de faire des prototypes par catégorie de variable: Sequence et Matrix, Integer et Matrix.</p>

<p>Revenons-en à notre <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">operator</span><span class="o">+</span>
</code></span> et son implémentation. Celle-ci va être plus compliqué car elle doit être équivalente aux 4 implémentations du début ; sachant que la première possède une variable et les opérandes sont inversés dans la troisième et la quatrième.</p>

<p>Une solution possible est de mettre 2 valeurs intermédiaires qui représentent l&rsquo;opérande de gauche et l&rsquo;opérande de droite et dont le type s&rsquo;adapte en fonction des types en entrée.</p>

<p>Ci-dessous un tableau récapitulatif des types et valeurs de nos 2 nouvelles variables <code>Lhs</code> et <code>Rhs</code>. Les <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">const</span>
</code></span> sont supprimés car seule la référence importe.</p>

<table>
<thead>
<tr>
<th>Prototype</th>
<th>NewLhs</th>
<th>NewRhs</th>
</tr>
</thead>

<tbody>
<tr>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span></td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span>   
</code></span> = lhs</td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span> = rhs</td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span></td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span> = lhs</td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span> = rhs</td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span></td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span> = rhs</td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;</span> 
</code></span> = lhs</td>
</tr>

<tr>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span>, <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span></td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span> = rhs</td>
<td><span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">M</span> <span class="o">&amp;&amp;</span>
</code></span> = lhs</td>
</tr>
</tbody>
</table>

<p>Et l&rsquo;implémentation:</p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">rvalue_wrapper</span>
<span class="p">{</span>
  <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">;</span>

  <span class="k">operator</span> <span class="n">T</span><span class="o">&amp;&amp;</span> <span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span>
  <span class="p">{</span> <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&amp;&amp;&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">unwrap</span><span class="p">(</span><span class="n">rvalue_wrapper</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">unwrap</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">Lhs</span><span class="p">,</span> <span class="k">class</span><span class="err"> </span><span class="nc">Rhs</span><span class="o">&gt;</span>
<span class="n">Matrix</span> <span class="k">operator</span> <span class="o">+</span><span class="p">(</span><span class="n">Lhs</span><span class="o">&amp;&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">Rhs</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="n">NewLhs</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">conditional_t</span><span class="o">&lt;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">is_lvalue_reference</span><span class="o">&lt;</span><span class="n">Lhs</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">is_lvalue_reference</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
    <span class="n">Matrix</span><span class="p">,</span>
    <span class="n">rvalue_wrapper</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;&gt;</span><span class="p">;</span>

  <span class="k">using</span> <span class="n">NewRhs</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">conditional_t</span><span class="o">&lt;</span>
    <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_lvalue_reference</span><span class="o">&lt;</span><span class="n">Lhs</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_lvalue_reference</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
    <span class="n">Matrix</span><span class="o">&amp;</span><span class="p">,</span>
    <span class="n">Matrix</span><span class="o">&amp;&amp;&gt;</span><span class="p">;</span>

  <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">swap_arg</span> <span class="o">=</span> <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_lvalue_reference</span><span class="o">&lt;</span><span class="n">Rhs</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>

  <span class="n">NewLhs</span> <span class="n">new_lhs</span><span class="p">{</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">swap_arg</span> <span class="o">?</span> <span class="nl">rhs</span> <span class="p">:</span> <span class="n">lhs</span><span class="p">)};</span>
  <span class="n">NewRhs</span> <span class="n">new_rhs</span><span class="p">{</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">NewRhs</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">swap_arg</span> <span class="o">?</span> <span class="nl">lhs</span> <span class="p">:</span> <span class="n">rhs</span><span class="p">))};</span>

  <span class="n">unwrap</span><span class="p">(</span><span class="n">new_lhs</span><span class="p">)</span> <span class="o">+=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">NewRhs</span><span class="o">&gt;</span><span class="p">(</span><span class="n">new_rhs</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">new_lhs</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Le code mérite quelques explications. Pour commencer, parlons de <code>rvalue_reference</code> qui est un palliatif pour une optimisation au niveau de <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">return</span>
</code></span>. Au niveau du retour, si <code>NewLhs</code> est une rvalue, il faut utiliser <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">move</span>
</code></span>, sauf que l&rsquo;utiliser sur une variable locale à la fonction bloque le RVO. Hélas, même avec un <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_rvalue_reference</span><span class="o">&lt;</span><span class="n">NewLhs</span><span class="o">&gt;</span><span class="p">{})</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
</code></span> avant <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">return</span> <span class="n">new_lhs</span>
</code></span> l&rsquo;optimisation n&rsquo;est pas faite. Cela fonctionne néanmoins avec <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">if</span> <span class="k">constexpr</span>
</code></span> de c++17. Le but de <code>rvalue_reference</code>  est finalement de rendre automatique un retour par rvalue grâce à l&rsquo;opérateur de cast interne.</p>

<p>Concernant ce curieux enchaînement de cast, celui-ci s&rsquo;explique par la difficulté de contrôler le type retourné par une ternaire. Une ternaire sur deux variables de même type va retourner une référence (une variable est toujours une lvalue). La référence sera considérée constante si une des deux valeurs est une référence constante. Du coup, on vire le const pour ensuite construire les types <code>NewLhs</code> et <code>NewRhs</code>.</p>

<p>Ici, le constructeur de la matrice (quand <code>NewLhs = Matrix</code>) va recevoir un type non const. À moins qu&rsquo;un constructeur existe pour les références non const, cela ne cause pas de problème. On peut très bien ajouter un <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">std</span><span class="o">::</span><span class="n">conditional</span>
</code></span> pour forcer le const.</p>

<p>En première impression <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">NewRhs</span><span class="o">&gt;</span>
</code></span> pourrait être optionnel, mais celui-ci permet de forcer la rvalue pour construire NewRhs. Une lvalue (le retour de <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&amp;&gt;</span>
</code></span>) ne pouvant être affectée à une rvalue sans cela.</p>

<p>Les casts présents fonctionnent bien parce que <code>lhs</code> et <code>rhs</code> sont tous deux du même type. Dans le cas contraire, il faut faire un branchement à la compilation via de la surcharge de fonction (dispatch de type) tel que font <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">falcon</span><span class="o">::</span><span class="n">cif</span>
</code></span> ou <span class="inlinecode highlight"><code class="language-cpp" data-lang="cpp"><span class="n">boost</span><span class="o">::</span><span class="n">hana</span><span class="o">::</span><span class="n">if_</span>
</code></span>. Plusieurs de mes articles en parlent.</p>

<a class="headline-hash" href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/#n-écrivez-pas-operator-vous-même-c-est-trop-compliqué-nbsp"><h2 id="n-écrivez-pas-operator-vous-même-c-est-trop-compliqué-nbsp">N&rsquo;écrivez pas operator+ vous-même, c&rsquo;est trop compliqué&nbsp;!</h2></a>

<p>Sérieusement, qui veut écrire une 20taine de lignes pour chaque opérateur ? Ne le faites pas, le code est alourdi, la lisibilité réduite. Il y a moyen d&rsquo;implémenter la plupart des opérateurs en quelques lignes pour le même résultat.</p>

<p>De plus, l&rsquo;implémentation des opérateurs peuvent varier. Par exemple, pas de commutativité. Ses variantes sont difficiles à détecter dans une grande masse de code, il devient facile de faire une erreur aussi bien à l&rsquo;écriture qu&rsquo;à la lecture.</p>

<p>Autre point, les types des opérandes peuvent être nombreux, faire tous les prototypes necessaires vous vaudra des heures de souffrances :).</p>

<p>Du coup, comment faire ? Une solution facile est d&rsquo;utiliser une macro pour implémenter les opérateurs voulus. C&rsquo;est simple et rapide, mais l&rsquo;utiliser avec des types template est un peu délicat. Cela reste néanmoins la solution la plus simple.</p>

<p>Une autre manière passe par du CRTP pour que la classe de base implémente les opérateurs voulus sous forme de fonction amie. C&rsquo;est la solution de <a href="http://www.boost.org/doc/libs/1_64_0/libs/utility/operators.htm">boost/operators.hpp</a>. Malheureusement, elle ne prend pas en compte les optimisations possibles sur les rvalues écrits dans cet article. Il faut la ré-écrire.</p>

<p>La dernière solution consiste à se servir des traits pour activer ou non certains prototypes comme dans le chapitre précédent. Une mise en oeuvre poussée peut être extrêmement extensible et s&rsquo;adapte très facilement aux catégories de valeur (séquence, intégrale), mais c&rsquo;est un poil complexe à mettre en place. Je ne connais pas de bibliothèque qui le fasse.</p>

<p>Au final, il n&rsquo;existe actuellement pas d&rsquo;outil satisfaisant pour générer les opérateurs alors qu&rsquo;il est presque aussi rapide d&rsquo;écrire une lib ou des macros pour le faire. Le temps perdu sera largement compensé par le nombre d&rsquo;opérateurs à implémenter par la suite. Avec un peu de jugeote, il est même possible de mutualiser l&rsquo;écriture des opérateurs <code>@=</code>. Pensez-y la prochaine fois qu&rsquo;il faudra écrire des opérateurs ;).</p>

  </div>
  <footer class="post__footer">
    <p class="post__meta meta">
  Le <time class="post__meta-date" datetime="2017-07-05T22:02:11">05 juillet 2017
</time> par Jonathan Poelen dans <a class="meta-categories__link" href="/categories/c&#43;&#43;" rel="category">c&#43;&#43;</a>
 ;
  

  <br/><a href="https://jonathanpoelen.github.io/2017/07/minimiser-les-copies-dans-operator-/"><i class="fas fa-link fa-fw" aria-hidden="true"></i>Lien permanent.</a>
</p>
<p class="post__meta meta share" id="8d66709af0c9e47357d2fae8b9c175bd-share">
  
  Partager Par
  <a title="Partager par email" href="mailto:?subject=minimiser-les-copies-dans-operator%2b&amp;Body=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f"><i class="fas fa-envelope-square fa-fw" aria-hidden="true"></i><span class="sr-only">Mail</span></a>
  <a title="Partager sur Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f&amp;title=minimiser-les-copies-dans-operator%2b" rel="noopener noreferrer"><i class="fab fa-linkedin fa-fw" aria-hidden="true" style="color: #0077B5"></i><span class="sr-only">Linkedin</span></a>
  <a title="Partager sur Twitter" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f" rel="noopener noreferrer"><i class="fab fa-twitter-square fa-fw" aria-hidden="true" style="color: #1DA1F2"></i><span class="sr-only">Twitter</span></a>
  <a title="Partager sur Google+" href="https://plus.google.com/share?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f" rel="noopener noreferrer"><i class="fab fa-google-plus-square fa-fw" aria-hidden="true" style="color: #DE5549"></i><span class="sr-only">Google+</span></a>
  <a title="Partager sur Facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f" rel="noopener noreferrer"><i class="fab fa-facebook-square fa-fw" aria-hidden="true" style="color: #4869b2"></i><span class="sr-only">Facebook</span></a>
  <a title="Partager sur Tumblr" href="https://www.tumblr.com/share/link?url=https%3a%2f%2fjonathanpoelen.github.io%2f2017%2f07%2fminimiser-les-copies-dans-operator-%2f&amp;name=minimiser-les-copies-dans-operator%2b" rel="noopener noreferrer"><i class="fab fa-tumblr-square fa-fw" aria-hidden="true" style="color: #349099"></i><span class="sr-only">Tumblr</span></a>
</p>

  </footer>
</article>


    
      
<div class="pagination clearfix">
  <span class="pagination__item pagination__item--current">1/4</span>
  <a class="pagination__item" href="/page/2/">2</a>
  <a class="pagination__item" href="/page/3/">3</a>
  <a class="pagination__item" href="/page/4/">4</a>
  <a class="pagination__item pagination__item--next" href="/page/2/">▶</a>
</div>


  </main>

</div>
  <footer class="footer" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
    <p class="footer-archive"><a href="/archives" title="Archives">Archives</a></p>
    <p class="footer__copyright">
       Jonathan Poelen&#39;s Blog. <span class="footer__copyright-credits">
      Généré avec <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a>
      et <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad theme</a>.
      Utilise <a href="http://fontawesome.io" rel="nofollow noopener" target="_blank">Font Awesome</a> de Dave Gandy pour les icônes.
      </span>
    </p>
  </footer>
</div>
<a id="backtop" href="#avoidance-link"><i class="fas fa-arrow-circle-up fa-3x" aria-hidden="true"></i><span class="sr-only">Revenir en haut</span></a>

</body>
</html>


